generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("account")
}

model CatalogoEquipo {
  id                               String                             @id
  categoriaId                      String
  unidadId                         String
  codigo                           String                             @unique
  descripcion                      String
  marca                            String
  precioLista                      Float
  precioInterno                    Float
  factorCosto                      Float                              @default(1.00)
  factorVenta                      Float                              @default(1.15)
  precioVenta                      Float
  estado                           String                             @default("pendiente")
  precioLogistica                  Float?
  precioReal                       Float?
  fechaActualizacion               DateTime?
  createdById                      String?
  updatedById                      String?
  createdAt                        DateTime                           @default(now())
  updatedAt                        DateTime                           @updatedAt
  categoriaEquipo                  CategoriaEquipo                    @relation(fields: [categoriaId], references: [id])
  unidad                           Unidad                             @relation(fields: [unidadId], references: [id])
  createdByUser                    User?                              @relation("EquipoCreadoPor", fields: [createdById], references: [id])
  updatedByUser                    User?                              @relation("EquipoActualizadoPor", fields: [updatedById], references: [id])
  cotizacionEquipoItem             CotizacionEquipoItem[]
  plantillaEquipoItem              PlantillaEquipoItem[]
  proyectoEquipoCotizadoItem       ProyectoEquipoCotizadoItem[]
  plantillaEquipoItemIndependiente PlantillaEquipoItemIndependiente[]
  listaEquipoItem                  ListaEquipoItem[]
  pedidoEquipoItems                PedidoEquipoItem[]

  @@map("catalogo_equipo")
}

model CatalogoServicio {
  id                                 String                               @id
  categoriaId                        String
  unidadServicioId                   String
  recursoId                          String
  nombre                             String
  descripcion                        String
  horaBase                           Float?
  horaRepetido                       Float?
  createdAt                          DateTime                             @default(now())
  updatedAt                          DateTime
  orden                              Int?                                 @default(0)
  cantidad                           Float?
  nivelDificultad                    Int?                                 @default(1)
  edt                                Edt                                  @relation(fields: [categoriaId], references: [id])
  recurso                            Recurso                              @relation(fields: [recursoId], references: [id])
  unidadServicio                     UnidadServicio                       @relation(fields: [unidadServicioId], references: [id])
  cotizacionServicioItem             CotizacionServicioItem[]
  plantillaServicioItem              PlantillaServicioItem[]
  proyectoServicioCotizadoItem       ProyectoServicioCotizadoItem[]
  plantillaServicioItemIndependiente PlantillaServicioItemIndependiente[]

  @@map("catalogo_servicio")
}

model CategoriaEquipo {
  id             String           @id
  nombre         String           @unique
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  descripcion    String?
  catalogoEquipo CatalogoEquipo[]

  @@map("categoria_equipo")
}

model CategoriaGasto {
  id             String          @id @default(cuid())
  nombre         String          @unique
  descripcion    String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  catalogoGastos CatalogoGasto[]
  gastoLineas    GastoLinea[]

  @@map("categoria_gasto")
}

model CategoriaCondicion {
  id                  String              @id @default(cuid())
  nombre              String              @unique
  descripcion         String?
  orden               Int                 @default(0)
  activo              Boolean             @default(true)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  catalogoCondiciones CatalogoCondicion[]

  @@map("categoria_condicion")
}

model CategoriaExclusion {
  id                  String              @id @default(cuid())
  nombre              String              @unique
  descripcion         String?
  orden               Int                 @default(0)
  activo              Boolean             @default(true)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  catalogoExclusiones CatalogoExclusion[]

  @@map("categoria_exclusion")
}

model CatalogoGasto {
  id            String         @id @default(cuid())
  codigo        String         @unique
  descripcion   String
  categoriaId   String
  cantidad      Float          @default(1)
  precioInterno Float
  margen        Float          @default(0.2)
  precioVenta   Float
  estado        String         @default("activo")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  categoria          CategoriaGasto      @relation(fields: [categoriaId], references: [id])
  cotizacionGastoItem CotizacionGastoItem[]

  @@map("catalogo_gasto")
}

model Cliente {
  id                       String                 @id
  codigo                   String                 @unique
  numeroSecuencia          Int?                   @default(1)
  nombre                   String
  ruc                      String?
  direccion                String?
  telefono                 String?
  correo                   String?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime
  calificacion             Int?                   @default(3)
  estadoRelacion           String                 @default("prospecto")
  frecuenciaCompra         String?
  linkedin                 String?
  potencialAnual           Float?
  sector                   String?
  sitioWeb                 String?
  tamanoEmpresa            String?
  ultimoProyecto           DateTime?
  calificacionSatisfaccion Int?                   @default(3)
  frecuenciaCompraMeses    Int?
  cotizacion               Cotizacion[]
  proyecto                 Proyecto[]
  crmContactoCliente       CrmContactoCliente[]
  crmHistorialProyecto     CrmHistorialProyecto[]
  crmOportunidad           CrmOportunidad[]
  cuentasPorCobrar         CuentaPorCobrar[]

  @@map("cliente")
}

model Cotizacion {
  id                        String                      @id
  clienteId                 String?
  comercialId               String?
  plantillaId               String?
  codigo                    String                      @unique
  numeroSecuencia           Int
  nombre                    String
  totalEquiposInterno       Float                       @default(0)
  totalEquiposCliente       Float                       @default(0)
  totalServiciosInterno     Float                       @default(0)
  totalServiciosCliente     Float                       @default(0)
  totalGastosInterno        Float                       @default(0)
  totalGastosCliente        Float                       @default(0)
  totalInterno              Float                       @default(0)
  totalCliente              Float                       @default(0)
  descuento                 Float                       @default(0)
  grandTotal                Float                       @default(0)
  prioridad                 String?
  probabilidad              Int?
  fechaEnvio                DateTime?
  fechaCierreEstimada       DateTime?
  notas                     String?
  createdAt                 DateTime                    @default(now())
  fecha                     DateTime                    @default(now())
  updatedAt                 DateTime
  fechaValidezHasta         DateTime?
  formaPago                 String?
  incluyeIGV                Boolean?                    @default(false)
  moneda                    String?                     @default("USD")
  tipoCambio                Float?
  referencia                String?
  revision                  String?                     @default("R01")
  validezOferta             Int?                        @default(15)
  competencia               String?
  fechaProximaAccion        DateTime?
  fechaUltimoContacto       DateTime?
  posicionVsCompetencia     String?
  prioridadCrm              String?                     @default("media")
  probabilidadCierre        Int?                        @default(0)
  proximaAccion             String?
  razonCierre               String?
  retroalimentacionCliente  String?
  calendarioLaboralId       String?
  fechaFin                  DateTime?
  fechaInicio               DateTime?
  estado                    EstadoCotizacion            @default(borrador)
  // Descuento con aprobación
  descuentoPorcentaje       Float?
  descuentoMotivo           String?
  descuentoEstado           String?
  descuentoSolicitadoPorId  String?
  descuentoAprobadoPorId    String?
  descuentoFechaRespuesta   DateTime?
  descuentoComentario       String?
  calendarioLaboral         CalendarioLaboral?          @relation(fields: [calendarioLaboralId], references: [id])
  cliente                   Cliente?                    @relation(fields: [clienteId], references: [id])
  user                      User?                       @relation(fields: [comercialId], references: [id])
  plantilla                 Plantilla?                  @relation(fields: [plantillaId], references: [id])
  descuentoSolicitadoPor    User?                       @relation("CotizacionDescuentoSolicitante", fields: [descuentoSolicitadoPorId], references: [id])
  descuentoAprobadoPor      User?                       @relation("CotizacionDescuentoAprobador", fields: [descuentoAprobadoPorId], references: [id])
  cotizacionEquipo          CotizacionEquipo[]
  cotizacionGasto           CotizacionGasto[]
  cotizacionServicio        CotizacionServicio[]
  proyecto                  Proyecto[]
  cotizacionCondicion       CotizacionCondicion[]
  cotizacionEdt             CotizacionEdt[]
  cotizacionExclusion       CotizacionExclusion[]
  cotizacionFase            CotizacionFase[]
  cotizacionPlantillaImport CotizacionPlantillaImport[]
  cotizacionVersion         CotizacionVersion[]
  crmCompetidorLicitacion   CrmCompetidorLicitacion[]
  crmHistorialProyecto      CrmHistorialProyecto[]
  crmOportunidad            CrmOportunidad?
  agenteConversaciones      AgenteConversacion[]
  cotizacionTdrAnalisis     CotizacionTdrAnalisis[]

  @@map("cotizacion")
}

model CotizacionTdrAnalisis {
  id                   String     @id @default(cuid())
  cotizacionId         String
  cotizacion           Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)

  resumenTdr           String     @db.Text
  requerimientos       Json?
  equiposIdentificados Json?
  serviciosIdentificados Json?
  ambiguedades         Json?
  consultasCliente     Json?
  supuestos            Json?
  exclusiones          Json?

  nombreArchivo        String?
  paginasPdf           Int?
  clienteDetectado     String?
  proyectoDetectado    String?
  ubicacionDetectada   String?
  alcanceDetectado     String?    @db.Text

  cronogramaEstimado   Json?
  presupuestoEstimado  Json?

  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  @@map("cotizacion_tdr_analisis")
}

model CotizacionEquipo {
  id                   String                 @id
  cotizacionId         String
  nombre               String
  descripcion          String?
  subtotalInterno      Float
  subtotalCliente      Float
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  plazoEntregaSemanas  Int?
  cotizacion           Cotizacion             @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  cotizacionEquipoItem CotizacionEquipoItem[]

  @@map("cotizacion_equipo")
}

model CotizacionEquipoItem {
  id                 String           @id
  cotizacionEquipoId String
  catalogoEquipoId   String?
  codigo             String
  descripcion        String
  categoria          String
  unidad             String
  marca              String
  precioLista        Float
  precioInterno      Float
  factorCosto        Float            @default(1.00)
  factorVenta        Float            @default(1.15)
  precioCliente      Float
  cantidad           Float
  costoInterno       Float
  costoCliente       Float
  createdAt          DateTime         @default(now())
  updatedAt          DateTime
  catalogoEquipo     CatalogoEquipo?  @relation(fields: [catalogoEquipoId], references: [id])
  cotizacionEquipo   CotizacionEquipo @relation(fields: [cotizacionEquipoId], references: [id], onDelete: Cascade)

  @@map("cotizacion_equipo_item")
}

model CotizacionGasto {
  id                  String                @id
  cotizacionId        String
  nombre              String
  descripcion         String?
  subtotalInterno     Float
  subtotalCliente     Float
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  plazoEntregaSemanas Int?
  cotizacion          Cotizacion            @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  cotizacionGastoItem CotizacionGastoItem[]

  @@map("cotizacion_gasto")
}

model CotizacionGastoItem {
  id              String          @id
  gastoId         String
  catalogoGastoId String?
  nombre          String
  descripcion     String?
  cantidad        Float
  precioUnitario  Float
  factorSeguridad Float           @default(1.0)
  margen          Float           @default(1.0)
  costoInterno    Float
  costoCliente    Float
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  cotizacionGasto CotizacionGasto @relation(fields: [gastoId], references: [id], onDelete: Cascade)
  catalogoGasto   CatalogoGasto?  @relation(fields: [catalogoGastoId], references: [id])

  @@map("cotizacion_gasto_item")
}

model CotizacionProveedor {
  id                      String                    @id
  proveedorId             String
  proyectoId              String
  codigo                  String                    @unique
  numeroSecuencia         Int
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  estado                  EstadoCotizacionProveedor @default(pendiente)
  proveedor               Proveedor                 @relation(fields: [proveedorId], references: [id])
  proyecto                Proyecto                  @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  cotizacionProveedorItem CotizacionProveedorItem[]

  @@index([proyectoId, estado])
  @@map("cotizacion_proveedor")
}

model CotizacionProveedorItem {
  id                          String                    @id
  cotizacionId                String
  listaEquipoItemId           String?
  codigo                      String
  descripcion                 String
  unidad                      String
  cantidadOriginal            Float
  precioUnitario              Float?
  cantidad                    Float?
  costoTotal                  Float?
  tiempoEntrega               String?
  tiempoEntregaDias           Int?
  estado                      EstadoCotizacionProveedor @default(pendiente)
  esSeleccionada              Boolean?                  @default(false)
  createdAt                   DateTime                  @default(now())
  updatedAt                   DateTime                  @updatedAt
  listaId                     String?
  cotizacionProveedor         CotizacionProveedor       @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  listaEquipoItem             ListaEquipoItem?          @relation("cotizacionProveedorItemListaEquipoItem", fields: [listaEquipoItemId], references: [id])
  listaEquipo                 ListaEquipo?              @relation(fields: [listaId], references: [id])
  cotizacionSeleccionadaItems ListaEquipoItem?          @relation("listaEquipoItemCotizacionSeleccionada")

  @@index([cotizacionId, estado])
  @@map("cotizacion_proveedor_item")
}

model CotizacionServicio {
  id                     String                   @id
  cotizacionId           String
  nombre                 String
  edtId                  String
  subtotalInterno        Float
  subtotalCliente        Float
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  plazoEntregaSemanas    Int?
  cotizacion             Cotizacion               @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  edt                    Edt                      @relation("CotizacionServicioEdt", fields: [edtId], references: [id])
  cotizacionServicioItem CotizacionServicioItem[]
  cotizacionEdt          CotizacionEdt[]

  @@map("cotizacion_servicio")
}

model CotizacionServicioItem {
  id                   String             @id
  cotizacionServicioId String
  catalogoServicioId   String?
  unidadServicioId     String
  recursoId            String
  nombre               String
  descripcion          String
  edtId                String
  unidadServicioNombre String
  recursoNombre        String
  formula              String
  horaBase             Float?
  horaRepetido         Float?
  horaUnidad           Float?
  horaFijo             Float?
  costoHora            Float
  cantidad             Int
  horaTotal            Float
  factorSeguridad      Float
  margen               Float
  costoInterno         Float
  costoCliente         Float
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  orden                Int?               @default(0)
  nivelDificultad      Int?               @default(1)
  modoCalculo          String?            @default("normal")
  catalogoServicio     CatalogoServicio?  @relation(fields: [catalogoServicioId], references: [id])
  cotizacionServicio   CotizacionServicio @relation(fields: [cotizacionServicioId], references: [id], onDelete: Cascade)
  edt                  Edt                @relation("CotizacionServicioItemEdt", fields: [edtId], references: [id])
  recurso              Recurso            @relation(fields: [recursoId], references: [id])
  unidadServicio       UnidadServicio     @relation(fields: [unidadServicioId], references: [id])
  cotizacionTarea      CotizacionTarea[]

  @@map("cotizacion_servicio_item")
}

model EntregaItem {
  id                 String               @id
  pedidoEquipoItemId String
  listaEquipoItemId  String?
  proyectoId         String
  fechaEntrega       DateTime
  estado             EstadoEntregaItem    @default(pendiente)
  cantidad           Float
  cantidadEntregada  Float?               @default(0)
  observaciones      String?
  fechaRegistro      DateTime             @default(now())
  usuarioId          String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  listaEquipoItem    ListaEquipoItem?     @relation(fields: [listaEquipoItemId], references: [id])
  pedidoEquipoItem   PedidoEquipoItem     @relation(fields: [pedidoEquipoItemId], references: [id])
  proyecto           Proyecto             @relation(fields: [proyectoId], references: [id])
  user               User?                @relation(fields: [usuarioId], references: [id])
  eventoTrazabilidad EventoTrazabilidad[]

  @@index([fechaEntrega])
  @@index([pedidoEquipoItemId])
  @@index([proyectoId, estado])
  @@map("entrega_item")
}

model EventoTrazabilidad {
  id              String             @id
  entregaItemId   String?
  proyectoId      String?
  pedidoEquipoId  String?
  tipo            String
  descripcion     String
  estadoAnterior  EstadoEntregaItem?
  estadoNuevo     EstadoEntregaItem?
  fechaEvento     DateTime           @default(now())
  usuarioId       String
  metadata        Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime
  entregaItem     EntregaItem?       @relation(fields: [entregaItemId], references: [id])
  proyecto        Proyecto?          @relation(fields: [proyectoId], references: [id])
  pedidoEquipo    PedidoEquipo?      @relation(fields: [pedidoEquipoId], references: [id])
  user            User               @relation(fields: [usuarioId], references: [id])

  @@index([entregaItemId])
  @@index([fechaEvento])
  @@index([proyectoId])
  @@index([pedidoEquipoId])
  @@index([tipo, fechaEvento])
  @@map("evento_trazabilidad")
}

model ListaEquipo {
  id                         String                       @id
  proyectoId                 String
  codigo                     String                       @unique
  nombre                     String
  numeroSecuencia            Int
  estado                     EstadoListaEquipo            @default(borrador)
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  responsableId              String
  fechaAprobacionFinal       DateTime?
  fechaAprobacionRevision    DateTime?
  fechaEnvioLogistica        DateTime?
  fechaEnvioRevision         DateTime?
  fechaFinCotizacion         DateTime?
  fechaInicioCotizacion      DateTime?
  fechaNecesaria             DateTime?
  fechaValidacion            DateTime?
  cotizacionProveedorItem    CotizacionProveedorItem[]
  proyecto                   Proyecto                     @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  user                       User                         @relation(fields: [responsableId], references: [id])
  listaEquipoItem            ListaEquipoItem[]
  pedidoEquipo               PedidoEquipo[]
  pedidoEquipoItem           PedidoEquipoItem[]
  proyectoEquipoCotizadoItem ProyectoEquipoCotizadoItem[]

  @@index([estado, fechaNecesaria, createdAt(sort: Desc)], map: "idx_lista_estado_necesaria_fecha")
  @@index([proyectoId, estado, createdAt(sort: Desc)], map: "idx_lista_proyecto_estado_fecha")
  @@index([responsableId, estado, fechaAprobacionFinal], map: "idx_lista_responsable_estado_aprobacion")
  @@map("lista_equipo")
}

model ListaEquipoItem {
  id                                    String                       @id @default(cuid())
  listaId                               String
  proyectoEquipoId                      String?
  proyectoEquipoItemId                  String?
  proveedorId                           String?
  cotizacionSeleccionadaId              String?                      @unique
  catalogoEquipoId                      String?
  codigo                                String
  descripcion                           String
  categoria                             String                       @default("SIN-CATEGORIA")
  tipoItem                              String                       @default("equipo")
  unidad                                String
  marca                                 String                       @default("SIN-MARCA")
  cantidad                              Float
  verificado                            Boolean                      @default(false)
  verificadoPorId                       String?
  verificadoAt                          DateTime?
  comentarioRevision                    String?
  presupuesto                           Float?
  precioElegido                         Float?
  costoElegido                          Float?
  costoPedido                           Float?                       @default(0)
  costoReal                             Float?                       @default(0)
  cantidadPedida                        Float?                       @default(0)
  cantidadEntregada                     Float?                       @default(0)
  estado                                EstadoListaItem              @default(borrador)
  createdAt                             DateTime                     @default(now())
  updatedAt                             DateTime                     @updatedAt
  origen                                OrigenListaItem              @default(nuevo)
  tiempoEntrega                         String?
  tiempoEntregaDias                     Int?
  responsableId                         String
  reemplazaProyectoEquipoCotizadoItemId String?
  cotizacionProveedorItems              CotizacionProveedorItem[]    @relation("cotizacionProveedorItemListaEquipoItem")
  entregaItem                           EntregaItem[]
  cotizacionSeleccionada                CotizacionProveedorItem?     @relation("listaEquipoItemCotizacionSeleccionada", fields: [cotizacionSeleccionadaId], references: [id])
  listaEquipo                           ListaEquipo                  @relation(fields: [listaId], references: [id], onDelete: Cascade)
  proveedor                             Proveedor?                   @relation(fields: [proveedorId], references: [id])
  proyectoEquipoCotizado                ProyectoEquipoCotizado?      @relation(fields: [proyectoEquipoId], references: [id])
  proyectoEquipoItem                    ProyectoEquipoCotizadoItem?  @relation("listaEquipoItemProyectoEquipoItem", fields: [proyectoEquipoItemId], references: [id])
  reemplazaProyectoEquipoCotizadoItem   ProyectoEquipoCotizadoItem?  @relation("listaEquipoItemReemplazaProyectoEquipoItem", fields: [reemplazaProyectoEquipoCotizadoItemId], references: [id])
  user                                  User                         @relation(fields: [responsableId], references: [id])
  verificadoPor                         User?                        @relation("ListaEquipoItemVerificador", fields: [verificadoPorId], references: [id])
  pedidoEquipoItem                      PedidoEquipoItem[]
  ordenCompraItems                      OrdenCompraItem[]
  listaEquipoItemSeleccionados          ProyectoEquipoCotizadoItem[] @relation("proyectoEquipoCotizadoItemListaEquipoSeleccionado")
  catalogoEquipo                        CatalogoEquipo?              @relation(fields: [catalogoEquipoId], references: [id])

  @@index([listaId, estado, createdAt(sort: Desc)], map: "idx_lista_item_lista_estado_fecha")
  @@index([proveedorId, estado, precioElegido], map: "idx_lista_item_proveedor_estado_precio")
  @@index([responsableId, estado, verificado], map: "idx_lista_item_responsable_estado_verificado")
  @@map("lista_equipo_item")
}

model PedidoEquipo {
  id                   String             @id
  proyectoId           String
  responsableId        String
  listaId              String?
  codigo               String             @unique
  numeroSecuencia      Int
  estado               EstadoPedido       @default(borrador)
  fechaPedido          DateTime           @default(now())
  observacion          String?
  fechaEntregaEstimada DateTime?
  fechaEntregaReal     DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  fechaNecesaria       DateTime
  costoRealTotal       Float              @default(0)
  esUrgente            Boolean            @default(false)
  presupuestoTotal     Float              @default(0)
  prioridad            String?            @default("media")
  listaEquipo          ListaEquipo?       @relation(fields: [listaId], references: [id])
  proyecto             Proyecto           @relation(fields: [proyectoId], references: [id])
  user                 User               @relation(fields: [responsableId], references: [id])
  pedidoEquipoItem     PedidoEquipoItem[]
  ordenesCompra        OrdenCompra[]
  eventosTrazabilidad  EventoTrazabilidad[]
  cuentasPorPagar      CuentaPorPagar[]

  @@index([estado, prioridad, createdAt(sort: Desc)], map: "idx_pedido_estado_prioridad_fecha")
  @@index([proyectoId, estado, createdAt(sort: Desc)], map: "idx_pedido_proyecto_estado_fecha")
  @@index([proyectoId, responsableId, estado], map: "idx_pedido_proyecto_responsable_estado")
  @@index([responsableId, estado, fechaNecesaria], map: "idx_pedido_responsable_estado_fecha")
  @@map("pedido_equipo")
}

model PedidoEquipoItem {
  id                          String            @id
  pedidoId                    String
  listaEquipoItemId           String?
  cantidadPedida              Float
  precioUnitario              Float?
  costoTotal                  Float?
  estado                      EstadoPedidoItem  @default(pendiente)
  cantidadAtendida            Float?
  comentarioLogistica         String?
  comentarioLogisticaPorId    String?
  comentarioLogisticaAt       DateTime?
  createdAt                   DateTime          @default(now())
  updatedAt                   DateTime          @updatedAt
  listaId                     String?
  codigo                      String
  descripcion                 String
  categoria                   String?
  tipoItem                    String                @default("equipo")
  marca                       String?
  catalogoEquipoId            String?
  tiempoEntrega               String?
  tiempoEntregaDias           Int?
  unidad                      String
  fechaOrdenCompraRecomendada DateTime?
  responsableId               String
  fechaEntregaEstimada        DateTime?
  fechaEntregaReal            DateTime?
  estadoEntrega               EstadoEntregaItem @default(pendiente)
  observacionesEntrega        String?
  proveedorId                 String?
  proveedorNombre             String?
  costoRealUnitario           Float?
  costoRealMoneda             String?
  motivoAtencionDirecta       String?
  entregaItem                 EntregaItem[]
  listaEquipoItem             ListaEquipoItem?  @relation(fields: [listaEquipoItemId], references: [id])
  listaEquipo                 ListaEquipo?      @relation(fields: [listaId], references: [id])
  pedidoEquipo                PedidoEquipo      @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  proveedor                   Proveedor?        @relation(fields: [proveedorId], references: [id], onDelete: SetNull)
  catalogoEquipo              CatalogoEquipo?   @relation(fields: [catalogoEquipoId], references: [id], onDelete: SetNull)
  user                        User              @relation(fields: [responsableId], references: [id])
  comentarioLogisticaPor      User?             @relation("PedidoEquipoItemComentarioLogistica", fields: [comentarioLogisticaPorId], references: [id])
  ordenCompraItems            OrdenCompraItem[]
  recepcionesPendientes       RecepcionPendiente[]
  cuentasPorPagar             CuentaPorPagar[]

  @@map("pedido_equipo_item")
}

model Plantilla {
  id                        String                      @id
  nombre                    String
  estado                    String                      @default("borrador")
  totalEquiposInterno       Float                       @default(0)
  totalEquiposCliente       Float                       @default(0)
  totalServiciosInterno     Float                       @default(0)
  totalServiciosCliente     Float                       @default(0)
  totalGastosInterno        Float                       @default(0)
  totalGastosCliente        Float                       @default(0)
  totalInterno              Float                       @default(0)
  totalCliente              Float                       @default(0)
  descuento                 Float                       @default(0)
  grandTotal                Float                       @default(0)
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  tipo                      PlantillaTipo               @default(completa)
  cotizacion                Cotizacion[]
  plantillaEquipo           PlantillaEquipo[]
  plantillaGasto            PlantillaGasto[]
  plantillaServicio         PlantillaServicio[]
  cotizacionPlantillaImport CotizacionPlantillaImport[]
  plantillaCondicion        PlantillaCondicion[]
  plantillaExclusion        PlantillaExclusion[]

  @@map("plantilla")
}

model PlantillaEquipo {
  id                  String                @id
  plantillaId         String
  nombre              String
  descripcion         String?
  subtotalInterno     Float
  subtotalCliente     Float
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  plantilla           Plantilla             @relation(fields: [plantillaId], references: [id], onDelete: Cascade)
  plantillaEquipoItem PlantillaEquipoItem[]

  @@map("plantilla_equipo")
}

model PlantillaEquipoItem {
  id                String          @id
  plantillaEquipoId String
  catalogoEquipoId  String?
  codigo            String
  descripcion       String
  categoria         String
  unidad            String
  marca             String
  precioLista       Float
  precioInterno     Float
  factorCosto       Float           @default(1.00)
  factorVenta       Float           @default(1.15)
  precioCliente     Float
  cantidad          Float
  costoInterno      Float
  costoCliente      Float
  createdAt         DateTime        @default(now())
  updatedAt         DateTime
  catalogoEquipo    CatalogoEquipo? @relation(fields: [catalogoEquipoId], references: [id])
  plantillaEquipo   PlantillaEquipo @relation(fields: [plantillaEquipoId], references: [id], onDelete: Cascade)

  @@map("plantilla_equipo_item")
}

model PlantillaGasto {
  id                 String               @id
  plantillaId        String
  nombre             String
  descripcion        String?
  subtotalInterno    Float
  subtotalCliente    Float
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  plantilla          Plantilla            @relation(fields: [plantillaId], references: [id], onDelete: Cascade)
  plantillaGastoItem PlantillaGastoItem[]

  @@map("plantilla_gasto")
}

model PlantillaGastoItem {
  id              String         @id
  gastoId         String
  nombre          String
  descripcion     String?
  cantidad        Float
  precioUnitario  Float
  factorSeguridad Float          @default(1.0)
  margen          Float          @default(1.0)
  costoInterno    Float
  costoCliente    Float
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  plantillaGasto  PlantillaGasto @relation(fields: [gastoId], references: [id], onDelete: Cascade)

  @@map("plantilla_gasto_item")
}

model PlantillaServicio {
  id                    String                  @id
  plantillaId           String
  nombre                String
  categoria             String
  descripcion           String?
  subtotalInterno       Float
  subtotalCliente       Float
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  plantilla             Plantilla               @relation(fields: [plantillaId], references: [id], onDelete: Cascade)
  plantillaServicioItem PlantillaServicioItem[]

  @@map("plantilla_servicio")
}

model PlantillaServicioItem {
  id                   String            @id
  plantillaServicioId  String
  catalogoServicioId   String?
  unidadServicioId     String
  recursoId            String
  nombre               String
  descripcion          String
  categoria            String
  unidadServicioNombre String
  recursoNombre        String
  formula              String
  horaBase             Float?
  horaRepetido         Float?
  horaUnidad           Float?
  horaFijo             Float?
  costoHora            Float
  cantidad             Int
  horaTotal            Float
  factorSeguridad      Float
  margen               Float
  costoInterno         Float
  costoCliente         Float
  createdAt            DateTime          @default(now())
  updatedAt            DateTime
  catalogoServicio     CatalogoServicio? @relation(fields: [catalogoServicioId], references: [id])
  plantillaServicio    PlantillaServicio @relation(fields: [plantillaServicioId], references: [id], onDelete: Cascade)
  recurso              Recurso           @relation(fields: [recursoId], references: [id])
  unidadServicio       UnidadServicio    @relation(fields: [unidadServicioId], references: [id])

  @@map("plantilla_servicio_item")
}

model Proveedor {
  id                  String                @id
  nombre              String
  ruc                 String?
  direccion           String?
  telefono            String?
  correo              String?
  contactoNombre      String?
  contactoTelefono    String?
  contactoCorreo      String?
  banco               String?
  numeroCuenta        String?
  cci                 String?
  tipoCuenta          String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  cotizacionProveedor CotizacionProveedor[]
  listaEquipoItem     ListaEquipoItem[]
  ordenesCompra       OrdenCompra[]
  cuentasPorPagar     CuentaPorPagar[]
  pedidoEquipoItems   PedidoEquipoItem[]

  @@map("proveedor")
}

model Proyecto {
  id                       String                     @id
  clienteId                String
  comercialId              String
  gestorId                 String
  supervisorId             String?
  liderId                  String?
  cotizacionId             String?
  nombre                   String
  descripcion              String?
  totalEquiposInterno      Float                      @default(0)
  totalServiciosInterno    Float                      @default(0)
  totalGastosInterno       Float                      @default(0)
  totalInterno             Float                      @default(0)
  totalCliente             Float                      @default(0)
  descuento                Float                      @default(0)
  grandTotal               Float                      @default(0)
  codigo                   String
  estado                   ProyectoEstado             @default(creado)
  fechaInicio              DateTime
  fechaFin                 DateTime?
  totalRealEquipos         Float                      @default(0)
  totalRealServicios       Float                      @default(0)
  totalRealGastos          Float                      @default(0)
  totalReal                Float                      @default(0)
  moneda                   String?                    @default("USD")
  tipoCambio               Float?
  diasGarantia             Int                        @default(365)
  adelantoPorcentaje       Float                      @default(0)
  adelantoMonto            Float                      @default(0)
  adelantoAmortizado       Float                      @default(0)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  deletedAt                DateTime?
  progresoGeneral          Int                        @default(0)
  cotizacionProveedor      CotizacionProveedor[]
  entregaItem              EntregaItem[]
  eventoTrazabilidad       EventoTrazabilidad[]
  listaEquipo              ListaEquipo[]
  pedidoEquipo             PedidoEquipo[]
  cliente                  Cliente                    @relation(fields: [clienteId], references: [id])
  comercial                User                       @relation("ProyectoComercial", fields: [comercialId], references: [id])
  cotizacion               Cotizacion?                @relation(fields: [cotizacionId], references: [id])
  gestor                   User                       @relation("ProyectoGestor", fields: [gestorId], references: [id])
  supervisor               User?                      @relation("ProyectoSupervisor", fields: [supervisorId], references: [id])
  lider                    User?                      @relation("ProyectoLider", fields: [liderId], references: [id])
  personalProyecto         PersonalProyecto[]
  proyectoEquipoCotizado   ProyectoEquipoCotizado[]
  proyectoGastoCotizado    ProyectoGastoCotizado[]
  proyectoServicioCotizado ProyectoServicioCotizado[]
  registroHoras            RegistroHoras[]
  valorizacion             Valorizacion[]
  crmHistorialProyecto     CrmHistorialProyecto[]
  crmOportunidad           CrmOportunidad[]
  proyectoCronograma       ProyectoCronograma[]
  proyectoEdt              ProyectoEdt[]
  proyectoFase             ProyectoFase[]
  registrosCampo           RegistroHorasCampo[]
  proyectoCondicion        ProyectoCondicion[]
  proyectoExclusion        ProyectoExclusion[]
  // Documentos financieros imputados al proyecto
  hojasDeGastos            HojaDeGastos[]
  ordenesCompra            OrdenCompra[]
  cuentasPorCobrar         CuentaPorCobrar[]
  cuentasPorPagar          CuentaPorPagar[]

  @@index([clienteId, estado, createdAt(sort: Desc)], map: "idx_proyecto_cliente_estado_fecha")
  @@index([comercialId, estado, fechaInicio], map: "idx_proyecto_comercial_estado_inicio")
  @@index([estado, fechaInicio, createdAt(sort: Desc)], map: "idx_proyecto_estado_inicio_fecha")
  @@index([gestorId, estado, fechaFin], map: "idx_proyecto_gestor_estado_fin")
  @@index([supervisorId], map: "idx_proyecto_supervisor")
  @@index([liderId], map: "idx_proyecto_lider")
  @@map("proyecto")
}

// Personal asignado al proyecto (roles dinámicos)
model PersonalProyecto {
  id              String              @id @default(cuid())
  proyectoId      String
  userId          String
  rol             RolPersonalProyecto
  fechaAsignacion DateTime            @default(now())
  fechaFin        DateTime?
  activo          Boolean             @default(true)
  notas           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  proyecto Proyecto @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([proyectoId, userId, rol])
  @@index([proyectoId, activo])
  @@index([userId, activo])
  @@map("personal_proyecto")
}

enum RolPersonalProyecto {
  programador
  cadista
  ingeniero
  lider
  tecnico
  coordinador
  asistente
}

model ProyectoEquipoCotizado {
  id                         String                       @id
  proyectoId                 String
  responsableId              String
  nombre                     String
  descripcion                String?
  subtotalInterno            Float
  subtotalCliente            Float
  subtotalReal               Float                        @default(0)
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime
  listaEquipoItem            ListaEquipoItem[]
  proyecto                   Proyecto                     @relation(fields: [proyectoId], references: [id])
  user                       User                         @relation(fields: [responsableId], references: [id])
  proyectoEquipoCotizadoItem ProyectoEquipoCotizadoItem[]

  @@map("proyecto_equipo_cotizado")
}

model ProyectoEquipoCotizadoItem {
  id                        String                 @id
  proyectoEquipoId          String
  catalogoEquipoId          String?
  listaId                   String?
  codigo                    String
  descripcion               String
  categoria                 String                 @default("SIN-CATEGORIA")
  unidad                    String
  marca                     String                 @default("SIN-MARCA")
  precioInterno             Float
  precioCliente             Float
  cantidad                  Float
  costoInterno              Float
  costoCliente              Float
  precioReal                Float                  @default(0)
  cantidadReal              Float                  @default(0)
  costoReal                 Float                  @default(0)
  tiempoEntrega             Int?
  fechaEntregaEstimada      DateTime?
  estado                    EstadoEquipoItem       @default(pendiente)
  motivoCambio              String?
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime
  listaEquipoSeleccionadoId String?
  listaEquipoItemsAsociados ListaEquipoItem[]      @relation("listaEquipoItemProyectoEquipoItem")
  listaEquipoItemsReemplazo ListaEquipoItem[]      @relation("listaEquipoItemReemplazaProyectoEquipoItem")
  catalogoEquipo            CatalogoEquipo?        @relation(fields: [catalogoEquipoId], references: [id])
  listaEquipoSeleccionado   ListaEquipoItem?       @relation("proyectoEquipoCotizadoItemListaEquipoSeleccionado", fields: [listaEquipoSeleccionadoId], references: [id])
  listaEquipo               ListaEquipo?           @relation(fields: [listaId], references: [id])
  proyectoEquipoCotizado    ProyectoEquipoCotizado @relation(fields: [proyectoEquipoId], references: [id], onDelete: Cascade)

  @@map("proyecto_equipo_cotizado_item")
}

model ProyectoGastoCotizado {
  id                        String                      @id
  proyectoId                String
  nombre                    String
  descripcion               String?
  subtotalInterno           Float
  subtotalCliente           Float
  subtotalReal              Float                       @default(0)
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  proyecto                  Proyecto                    @relation(fields: [proyectoId], references: [id])
  proyectoGastoCotizadoItem ProyectoGastoCotizadoItem[]

  @@map("proyecto_gasto_cotizado")
}

model ProyectoGastoCotizadoItem {
  id                    String                @id
  gastoId               String
  nombre                String
  descripcion           String?
  cantidad              Float
  precioUnitario        Float
  factorSeguridad       Float
  margen                Float
  costoInterno          Float
  costoCliente          Float
  costoReal             Float                 @default(0)
  createdAt             DateTime              @default(now())
  updatedAt             DateTime
  proyectoGastoCotizado ProyectoGastoCotizado @relation(fields: [gastoId], references: [id])

  @@map("proyecto_gasto_cotizado_item")
}

model ProyectoServicioCotizado {
  id                           String                         @id
  proyectoId                   String
  responsableId                String
  nombre                       String
  edtId                        String
  subtotalInterno              Float
  subtotalCliente              Float
  subtotalReal                 Float                          @default(0)
  createdAt                    DateTime                       @default(now())
  updatedAt                    DateTime
  proyecto                     Proyecto                       @relation(fields: [proyectoId], references: [id])
  user                         User                           @relation(fields: [responsableId], references: [id])
  edt                          Edt                            @relation("ProyectoServicioCotizadoEdt", fields: [edtId], references: [id])
  proyectoServicioCotizadoItem ProyectoServicioCotizadoItem[]
  registroHoras                RegistroHoras[]
  tareas                       Tarea[]

  @@map("proyecto_servicio_cotizado")
}

model ProyectoServicioCotizadoItem {
  id                       String                   @id
  proyectoServicioId       String
  catalogoServicioId       String?
  edtId                    String
  costoHoraInterno         Float
  costoHoraCliente         Float
  nombre                   String
  cantidadHoras            Int
  costoInterno             Float
  costoCliente             Float
  costoReal                Float                    @default(0)
  horasEjecutadas          Float                    @default(0)
  motivoCambio             String?
  nuevo                    Boolean                  @default(false)
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime
  catalogoServicio         CatalogoServicio?        @relation(fields: [catalogoServicioId], references: [id])
  proyectoServicioCotizado ProyectoServicioCotizado @relation(fields: [proyectoServicioId], references: [id])
  edt                      Edt                      @relation("ProyectoServicioCotizadoItemEdt", fields: [edtId], references: [id])

  @@map("proyecto_servicio_cotizado_item")
}

model Recurso {
  id                                 String                               @id @default(cuid())
  nombre                             String                               @unique
  tipo                               TipoRecurso                          @default(individual)
  origen                             OrigenRecurso                        @default(propio)
  costoHora                          Float
  costoHoraProyecto                  Float?
  descripcion                        String?
  orden                              Int                                  @default(0)
  activo                             Boolean                              @default(true)
  createdAt                          DateTime                             @default(now())
  updatedAt                          DateTime                             @updatedAt
  catalogoServicio                   CatalogoServicio[]
  cotizacionServicioItem             CotizacionServicioItem[]
  plantillaServicioItem              PlantillaServicioItem[]
  registroHoras                      RegistroHoras[]
  plantillaServicioItemIndependiente PlantillaServicioItemIndependiente[]
  composiciones                      RecursoComposicion[]
  proyectoTareas                     ProyectoTarea[]

  @@map("recurso")
}

model RegistroHoras {
  id                       String                     @id
  proyectoId               String
  proyectoServicioId       String
  categoria                String
  nombreServicio           String
  recursoId                String
  recursoNombre            String
  usuarioId                String
  fechaTrabajo             DateTime
  horasTrabajadas          Float
  descripcion              String?
  observaciones            String?
  aprobado                 Boolean                    @default(false)
  proyectoEdtId            String?
  edtId                    String?
  origen                   OrigenTrabajo?
  ubicacion                String?
  costoHora                Float?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  proyectoTareaId          String?
  edt                      Edt?                       @relation(fields: [edtId], references: [id])
  proyectoEdt              ProyectoEdt?               @relation(fields: [proyectoEdtId], references: [id])
  proyecto                 Proyecto                   @relation(fields: [proyectoId], references: [id])
  proyectoServicioCotizado ProyectoServicioCotizado   @relation(fields: [proyectoServicioId], references: [id])
  proyectoTarea            ProyectoTarea?             @relation(fields: [proyectoTareaId], references: [id])
  recurso                  Recurso                    @relation(fields: [recursoId], references: [id])
  user                     User                       @relation(fields: [usuarioId], references: [id])
  origenCampoMiembro       RegistroHorasCampoMiembro?

  @@index([edtId, fechaTrabajo])
  @@index([origen, fechaTrabajo])
  @@index([proyectoEdtId, proyectoTareaId, fechaTrabajo])
  @@index([proyectoTareaId, fechaTrabajo])
  @@map("registro_horas")
}

// =============================================
// Registro de Horas en Campo (Cuadrilla)
// =============================================
// Estructura: 1 Registro = 1 Proyecto + 1 EDT + N Tareas
// Cada Tarea tiene su propio personal con horas independientes
model RegistroHorasCampo {
  id              String              @id @default(cuid())
  proyectoId      String
  proyectoEdtId   String?
  supervisorId    String
  fechaTrabajo    DateTime
  descripcion     String?
  ubicacion       String?
  estado          EstadoRegistroCampo @default(iniciado)
  fechaAprobacion DateTime?
  aprobadoPorId   String?
  motivoRechazo   String?

  // Campos para Jornada de Campo
  objetivosDia        String?   // Objetivos planificados al inicio del día
  personalPlanificado Json?     // [{userId, nombre}] - Personal planificado
  avanceDia           String?   // Resumen de avance al cierre
  bloqueos            Json?     // [{descripcion, impacto?, accion?}]
  planSiguiente       String?   // Plan para el día siguiente
  fechaCierre         DateTime? // Cuando se cerró la jornada

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  proyecto    Proyecto                  @relation(fields: [proyectoId], references: [id])
  proyectoEdt ProyectoEdt?              @relation(fields: [proyectoEdtId], references: [id])
  supervisor  User                      @relation("RegistrosCampoSupervisor", fields: [supervisorId], references: [id])
  aprobadoPor User?                     @relation("RegistrosCampoAprobador", fields: [aprobadoPorId], references: [id])
  tareas      RegistroHorasCampoTarea[]

  @@index([proyectoId, estado, fechaTrabajo])
  @@index([supervisorId, estado])
  @@index([estado, createdAt(sort: Desc)])
  @@map("registro_horas_campo")
}

// Tarea dentro de un registro de campo
// Puede ser una tarea del cronograma o una tarea extra (nombreTareaExtra)
model RegistroHorasCampoTarea {
  id                 String   @id @default(cuid())
  registroCampoId    String
  proyectoTareaId    String?
  nombreTareaExtra   String?
  descripcion        String?
  porcentajeInicial  Int?
  porcentajeFinal    Int?
  createdAt          DateTime @default(now())

  registroCampo RegistroHorasCampo          @relation(fields: [registroCampoId], references: [id], onDelete: Cascade)
  proyectoTarea ProyectoTarea?              @relation(fields: [proyectoTareaId], references: [id])
  miembros      RegistroHorasCampoMiembro[]

  @@index([registroCampoId])
  @@index([proyectoTareaId])
  @@map("registro_horas_campo_tarea")
}

// Miembro asignado a una tarea específica dentro del registro de campo
model RegistroHorasCampoMiembro {
  id                   String   @id @default(cuid())
  registroCampoTareaId String
  usuarioId            String
  horas                Float
  observaciones        String?
  registroHorasId      String?  @unique
  createdAt            DateTime @default(now())

  registroCampoTarea RegistroHorasCampoTarea @relation(fields: [registroCampoTareaId], references: [id], onDelete: Cascade)
  usuario            User                    @relation(fields: [usuarioId], references: [id])
  registroHoras      RegistroHoras?          @relation(fields: [registroHorasId], references: [id])

  @@index([registroCampoTareaId])
  @@index([usuarioId])
  @@map("registro_horas_campo_miembro")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Unidad {
  id             String           @id
  nombre         String           @unique
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  catalogoEquipo CatalogoEquipo[]

  @@map("unidad")
}

model UnidadServicio {
  id                                 String                               @id
  nombre                             String                               @unique
  createdAt                          DateTime                             @default(now())
  updatedAt                          DateTime
  catalogoServicio                   CatalogoServicio[]
  cotizacionServicioItem             CotizacionServicioItem[]
  plantillaServicioItem              PlantillaServicioItem[]
  plantillaServicioItemIndependiente PlantillaServicioItemIndependiente[]

  @@map("unidad_servicio")
}

model User {
  id                        String                      @id @default(cuid())
  name                      String?
  email                     String                      @unique
  emailVerified             DateTime?
  password                  String?
  role                      Role                        @default(colaborador)
  image                     String?
  lastLoginAt               DateTime?
  lastActivityAt            DateTime?
  metaMensual               Float?
  metaTrimestral            Float?
  Account                   Account[]
  cotizacion                Cotizacion[]
  entregaItem               EntregaItem[]
  eventoTrazabilidad        EventoTrazabilidad[]
  listaEquipo               ListaEquipo[]
  listaEquipoItem           ListaEquipoItem[]
  pedidoEquipo              PedidoEquipo[]
  pedidoEquipoItem          PedidoEquipoItem[]
  proyectosComoComercial    Proyecto[]                  @relation("ProyectoComercial")
  proyectosComoGestor       Proyecto[]                  @relation("ProyectoGestor")
  proyectosComoSupervisor   Proyecto[]                  @relation("ProyectoSupervisor")
  proyectosComoLider        Proyecto[]                  @relation("ProyectoLider")
  personalProyecto          PersonalProyecto[]
  proyectoEquipoCotizado    ProyectoEquipoCotizado[]
  proyectoServicioCotizado  ProyectoServicioCotizado[]
  registroHoras             RegistroHoras[]
  Session                   Session[]
  asignacionesRecurso       AsignacionRecurso[]
  auditLog                  AuditLog[]
  cotizacionEdt             CotizacionEdt[]
  cotizacionPlantillaImport CotizacionPlantillaImport[]
  cotizacionTarea           CotizacionTarea[]
  cotizacionVersion         CotizacionVersion[]
  crmActividad              CrmActividad[]
  crmMetricaComercial       CrmMetricaComercial[]
  crmOportunidadComercial   CrmOportunidad[]            @relation("CrmOportunidadComercial")
  crmOportunidadResponsable CrmOportunidad[]            @relation("CrmOportunidadResponsable")
  metricaComercial          MetricaComercial[]
  notificaciones            Notificacion[]
  proyectoActividad         ProyectoActividad[]
  proyectoEdt               ProyectoEdt[]
  proyectoSubtarea          ProyectoSubtarea[]
  tareasAsignadas           ProyectoTarea[]             @relation("TareaResponsable")
  tareasCreadas             ProyectoTarea[]             @relation("TareaCreadaPor")
  registrosProgreso         RegistroProgreso[]
  subtareas                 Subtarea[]
  tareas                    Tarea[]
  userPermissions           UserPermission[]
  empleado                  Empleado?
  departamentosResponsable  Departamento[]              @relation("DepartamentoResponsable")
  configuracionGeneral      ConfiguracionGeneral[]
  // Registro de horas en campo
  registrosCampoSupervisor  RegistroHorasCampo[]        @relation("RegistrosCampoSupervisor")
  registrosCampoAprobador   RegistroHorasCampo[]        @relation("RegistrosCampoAprobador")
  miembrosCuadrilla         RegistroHorasCampoMiembro[]
  // Trazabilidad
  listaEquipoItemsVerificados           ListaEquipoItem[]            @relation("ListaEquipoItemVerificador")
  pedidoEquipoItemsComentados           PedidoEquipoItem[]           @relation("PedidoEquipoItemComentarioLogistica")
  // Descuentos cotización
  cotizacionDescuentosSolicitados       Cotizacion[]                 @relation("CotizacionDescuentoSolicitante")
  cotizacionDescuentosAprobados         Cotizacion[]                 @relation("CotizacionDescuentoAprobador")
  // Hojas de gastos
  hojasComoEmpleado                     HojaDeGastos[]               @relation("HojaEmpleado")
  hojasComoAprobador                    HojaDeGastos[]               @relation("HojaAprobador")
  hojasEventos                          HojaDeGastosEvento[]         @relation("HojaEventoUsuario")
  // Órdenes de compra
  ordenesCompraSolicitante              OrdenCompra[]                @relation("OCsolicitante")
  ordenesCompraAprobador                OrdenCompra[]                @relation("OCaprobador")
  // Timesheet aprobación
  timesheetsEnviados                    TimesheetAprobacion[]        @relation("TimesheetUsuario")
  timesheetsAprobados                   TimesheetAprobacion[]        @relation("TimesheetAprobador")
  // Agente IA conversaciones
  agenteConversaciones                  AgenteConversacion[]
  agenteConversacionMensajes            AgenteConversacionMensaje[]
  agenteUsage                           AgenteUsage[]
  // Catálogo equipos tracking
  equiposCreadosPor                     CatalogoEquipo[]             @relation("EquipoCreadoPor")
  equiposActualizadosPor                CatalogoEquipo[]             @relation("EquipoActualizadoPor")
  // Recepciones pendientes
  recepcionesConfirmadas                RecepcionPendiente[]         @relation("RecepcionConfirmador")
  recepcionesEntregadas                 RecepcionPendiente[]         @relation("RecepcionEntregador")
  recepcionesRechazadas                 RecepcionPendiente[]         @relation("RecepcionRechazador")
  cxpAdjuntos                           CxPAdjunto[]                 @relation("CxPAdjuntoSubidoPor")
  cxcAdjuntos                           CxCAdjunto[]                 @relation("CxCAdjuntoSubidoPor")

  @@map("user")
}

// ======================
// 🏢 Departamento
// ======================
model Departamento {
  id            String     @id @default(cuid())
  nombre        String     @unique
  descripcion   String?
  responsableId String?
  activo        Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  responsable   User?      @relation("DepartamentoResponsable", fields: [responsableId], references: [id])
  empleados     Empleado[]

  @@map("departamento")
}

// ======================
// 💼 Cargo (Puesto de trabajo)
// ======================
model Cargo {
  id          String     @id @default(cuid())
  nombre      String     @unique
  descripcion String?
  sueldoBase  Float? // Sueldo de referencia (no se usa en cálculos)
  activo      Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  empleados   Empleado[]

  @@map("cargo")
}

model Empleado {
  id                   String               @id @default(cuid())
  userId               String               @unique
  cargoId              String?
  departamentoId       String?
  sueldoPlanilla       Float? // Sueldo en planilla (remuneración base)
  sueldoHonorarios     Float? // Sueldo adicional en honorarios
  asignacionFamiliar   Float                @default(0) // Asignación familiar (10% RMV si aplica)
  emo                  Float                @default(25) // EMO mensual (Examen Médico Ocupacional)
  fechaIngreso         DateTime?
  fechaCese            DateTime?
  activo               Boolean              @default(true)
  documentoIdentidad   String?
  telefono             String?
  direccion            String?
  contactoEmergencia   String?
  telefonoEmergencia   String?
  observaciones        String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  cargo                Cargo?               @relation(fields: [cargoId], references: [id])
  departamento         Departamento?        @relation(fields: [departamentoId], references: [id])
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  recursoComposiciones RecursoComposicion[]

  @@map("empleado")
}

model RecursoComposicion {
  id             String   @id @default(cuid())
  recursoId      String
  empleadoId     String
  cantidad       Int      @default(1)   // Número de personas de este perfil
  horasAsignadas Float? // Horas asignadas (opcional, alternativa a %)
  rol            String? // Rol dentro del recurso (ej: "Líder", "Ayudante")
  activo         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  recurso        Recurso  @relation(fields: [recursoId], references: [id], onDelete: Cascade)
  empleado       Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade)

  @@unique([recursoId, empleadoId])
  @@map("recurso_composicion")
}

model Valorizacion {
  id                          String              @id @default(cuid())
  proyectoId                  String
  numero                      Int                 // secuencial por proyecto: 1, 2, 3...
  codigo                      String              @unique // "{codigoProyecto}-VAL-{numero}"
  periodoInicio               DateTime
  periodoFin                  DateTime
  moneda                      String              @default("PEN")
  tipoCambio                  Float?
  // Montos de avance
  presupuestoContractual      Float               // monto total del contrato
  acumuladoAnterior           Float               @default(0) // calculado: SUM valorizaciones anteriores
  montoValorizacion           Float               // monto de esta valorización
  acumuladoActual             Float               @default(0) // calculado: acumuladoAnterior + montoValorizacion
  saldoPorValorizar           Float               @default(0) // calculado: presupuestoContractual - acumuladoActual
  porcentajeAvance            Float               @default(0) // calculado: acumuladoActual / presupuestoContractual * 100
  // Montos financieros
  descuentoComercialPorcentaje Float              @default(0)
  descuentoComercialMonto     Float               @default(0) // calculado
  adelantoPorcentaje          Float               @default(0)
  adelantoMonto               Float               @default(0) // calculado
  subtotal                    Float               @default(0) // calculado: montoValorizacion - descuento - adelanto
  igvPorcentaje               Float               @default(18)
  igvMonto                    Float               @default(0) // calculado
  fondoGarantiaPorcentaje     Float               @default(0)
  fondoGarantiaMonto          Float               @default(0) // calculado
  netoARecibir                Float               @default(0) // calculado: subtotal + IGV - fondoGarantia
  // Estado y fechas
  estado                      EstadoValorizacion  @default(borrador)
  fechaEnvio                  DateTime?
  fechaAprobacion             DateTime?
  fechaObservacion            DateTime?
  fechaCorreccion             DateTime?
  motivoObservacion           String?
  ciclosAprobacion            Int                 @default(0)
  observaciones               String?
  createdAt                   DateTime            @default(now())
  updatedAt                   DateTime

  proyecto  Proyecto              @relation(fields: [proyectoId], references: [id])
  adjuntos  ValorizacionAdjunto[]
  cuentasPorCobrar CuentaPorCobrar[]
  partidas  PartidaValorizacion[]

  @@unique([proyectoId, numero])
  @@index([proyectoId, estado])
  @@index([estado, createdAt(sort: Desc)])
  @@map("valorizacion")
}

model ValorizacionAdjunto {
  id              String   @id @default(cuid())
  valorizacionId  String
  nombreArchivo   String
  urlArchivo      String
  driveFileId     String?
  tipoArchivo     String?  // "excel", "pdf"
  tamano          Int?
  createdAt       DateTime @default(now())

  valorizacion Valorizacion @relation(fields: [valorizacionId], references: [id], onDelete: Cascade)

  @@index([valorizacionId])
  @@map("valorizacion_adjunto")
}

model PartidaValorizacion {
  id             String        @id @default(cuid())
  valorizacionId String
  valorizacion   Valorizacion  @relation(fields: [valorizacionId], references: [id], onDelete: Cascade)

  numero         Int
  descripcion    String
  origen         OrigenPartida @default(libre)

  // Vínculos con cotización
  proyectoEquipoCotizadoId    String?
  proyectoServicioCotizadoId  String?
  proyectoGastoCotizadoId     String?

  // Vínculo con cronograma de ejecución
  proyectoEdtId  String?

  // Montos
  montoContractual            Float   @default(0)
  porcentajeAvance            Float   @default(0)
  montoAvance                 Float   @default(0)

  // Acumulado de valorizaciones anteriores (snapshot al crear)
  porcentajeAcumuladoAnterior Float   @default(0)
  montoAcumuladoAnterior      Float   @default(0)

  orden          Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([valorizacionId])
  @@map("partida_valorizacion")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_token")
}

model AnalyticsEvent {
  id        String   @id
  event     String
  category  String
  action    String
  label     String?
  value     Float?
  metadata  Json?
  timestamp DateTime @default(now())
  userId    String?
  sessionId String
  userAgent String
  url       String

  @@index([category, event, timestamp(sort: Desc)])
  @@index([sessionId, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@index([userId, timestamp(sort: Desc)])
  @@map("analytics_events")
}

model AsignacionRecurso {
  id             String   @id
  rol            String
  horasAsignadas Decimal? @db.Decimal(10, 2)
  tareaId        String
  usuarioId      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  tarea          Tarea    @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([tareaId, usuarioId])
  @@map("asignaciones_recurso")
}

model AuditLog {
  id          String   @id
  entidadTipo String
  entidadId   String
  accion      String
  usuarioId   String
  descripcion String
  cambios     String?
  metadata    String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [usuarioId], references: [id])

  @@index([accion, createdAt(sort: Desc)])
  @@index([entidadTipo, entidadId, createdAt(sort: Desc)])
  @@index([usuarioId, createdAt(sort: Desc)])
  @@map("audit_log")
}

model TipoBloqueo {
  id          String   @id @default(cuid())
  nombre      String   @unique
  descripcion String?
  activo      Boolean  @default(true)
  orden       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([activo, orden])
  @@map("tipo_bloqueo")
}

model CalendarioLaboral {
  id                      String                    @id
  nombre                  String                    @unique
  descripcion             String?
  pais                    String?
  empresa                 String?
  activo                  Boolean                   @default(true)
  horasPorDia             Float                     @default(8.0)
  diasLaborables          DiaSemana[]
  horaInicioManana        String                    @default("08:00")
  horaFinManana           String                    @default("12:00")
  horaInicioTarde         String                    @default("13:00")
  horaFinTarde            String                    @default("17:00")
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  cotizacion              Cotizacion[]
  configuracionCalendario ConfiguracionCalendario[]
  diaCalendario           DiaCalendario[]
  excepcionCalendario     ExcepcionCalendario[]

  @@map("calendario_laboral")
}

model ConfiguracionCalendario {
  id                       String            @id
  calendarioLaboralId      String
  entidadTipo              String
  entidadId                String
  calendarioPredeterminado Boolean           @default(false)
  calendarioLaboral        CalendarioLaboral @relation(fields: [calendarioLaboralId], references: [id], onDelete: Cascade)

  @@unique([entidadTipo, entidadId])
  @@map("configuracion_calendario")
}

model CotizacionActividad {
  id                   String            @id
  cotizacionEdtId      String
  nombre               String
  orden                Int               @default(0)
  fechaInicioComercial DateTime?
  fechaFinComercial    DateTime?
  estado               EstadoActividad   @default(pendiente)
  porcentajeAvance     Int               @default(0)
  horasEstimadas       Decimal?          @db.Decimal(10, 2)
  descripcion          String?
  prioridad            PrioridadEdt      @default(media)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime
  cotizacionEdt        CotizacionEdt     @relation(fields: [cotizacionEdtId], references: [id], onDelete: Cascade)
  cotizacionTarea      CotizacionTarea[]

  @@index([cotizacionEdtId, orden])
  @@map("cotizacion_actividad")
}

model CotizacionCondicion {
  id                  String             @id
  cotizacionId        String
  catalogoCondicionId String?
  tipo                String?
  descripcion         String
  orden               Int?               @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime
  cotizacion          Cotizacion         @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  catalogoCondicion   CatalogoCondicion? @relation(fields: [catalogoCondicionId], references: [id])

  @@index([cotizacionId, orden])
  @@map("cotizacion_condicion")
}

model CotizacionDependenciasTarea {
  id                 String          @id
  tareaOrigenId      String
  tareaDependienteId String
  tipo               TipoDependencia @default(finish_to_start)
  lagMinutos         Int             @default(0)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime
  tareaDependiente   CotizacionTarea @relation("dependenciasCotizacionTareaDependiente", fields: [tareaDependienteId], references: [id], onDelete: Cascade)
  tareaOrigen        CotizacionTarea @relation("dependenciasCotizacionTareaOrigen", fields: [tareaOrigenId], references: [id], onDelete: Cascade)

  @@unique([tareaOrigenId, tareaDependienteId])
  @@map("cotizacion_dependencias_tarea")
}

model CotizacionEdt {
  id                   String                @id
  cotizacionId         String
  cotizacionServicioId String?
  edtId                String?
  fechaInicioComercial DateTime?
  fechaFinComercial    DateTime?
  horasEstimadas       Decimal?              @default(0) @db.Decimal(10, 2)
  estado               EstadoEdt             @default(planificado)
  responsableId        String?
  descripcion          String?
  prioridad            PrioridadEdt          @default(media)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime
  cotizacionFaseId     String?
  nombre               String
  orden                Int                   @default(0)
  cotizacionActividad  CotizacionActividad[]
  edt                  Edt?                  @relation(fields: [edtId], references: [id])
  cotizacionFase       CotizacionFase?       @relation(fields: [cotizacionFaseId], references: [id])
  cotizacion           Cotizacion            @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  cotizacionServicio   CotizacionServicio?   @relation(fields: [cotizacionServicioId], references: [id])
  user                 User?                 @relation(fields: [responsableId], references: [id])

  @@unique([cotizacionId, nombre])
  @@index([cotizacionId, cotizacionServicioId])
  @@index([cotizacionId, orden])
  @@index([estado, fechaFinComercial])
  @@index([responsableId, estado])
  @@map("cotizacion_edt")
}

model CotizacionExclusion {
  id                  String             @id
  cotizacionId        String
  catalogoExclusionId String?
  descripcion         String
  orden               Int?               @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime
  cotizacion          Cotizacion         @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  catalogoExclusion   CatalogoExclusion? @relation(fields: [catalogoExclusionId], references: [id])

  @@index([cotizacionId, orden])
  @@map("cotizacion_exclusion")
}

model PlantillaCondicion {
  id                  String             @id @default(cuid())
  plantillaId         String
  catalogoCondicionId String?
  tipo                String?
  descripcion         String
  orden               Int?               @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  plantilla           Plantilla          @relation(fields: [plantillaId], references: [id], onDelete: Cascade)
  catalogoCondicion   CatalogoCondicion? @relation(fields: [catalogoCondicionId], references: [id])

  @@index([plantillaId, orden])
  @@map("plantilla_condicion")
}

model PlantillaExclusion {
  id                  String             @id @default(cuid())
  plantillaId         String
  catalogoExclusionId String?
  descripcion         String
  orden               Int?               @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  plantilla           Plantilla          @relation(fields: [plantillaId], references: [id], onDelete: Cascade)
  catalogoExclusion   CatalogoExclusion? @relation(fields: [catalogoExclusionId], references: [id])

  @@index([plantillaId, orden])
  @@map("plantilla_exclusion")
}

model ProyectoCondicion {
  id                  String             @id @default(cuid())
  proyectoId          String
  catalogoCondicionId String?
  tipo                String?
  descripcion         String
  orden               Int?               @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime
  proyecto            Proyecto           @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  catalogoCondicion   CatalogoCondicion? @relation(fields: [catalogoCondicionId], references: [id])

  @@index([proyectoId, orden])
  @@map("proyecto_condicion")
}

model ProyectoExclusion {
  id                  String             @id @default(cuid())
  proyectoId          String
  catalogoExclusionId String?
  descripcion         String
  orden               Int?               @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime
  proyecto            Proyecto           @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  catalogoExclusion   CatalogoExclusion? @relation(fields: [catalogoExclusionId], references: [id])

  @@index([proyectoId, orden])
  @@map("proyecto_exclusion")
}

model CotizacionFase {
  id               String          @id
  cotizacionId     String
  nombre           String
  descripcion      String?
  orden            Int             @default(0)
  fechaInicioPlan  DateTime?
  fechaFinPlan     DateTime?
  estado           EstadoFase      @default(planificado)
  porcentajeAvance Int             @default(0)
  horasEstimadas   Decimal?        @db.Decimal(10, 2)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime
  cotizacionEdt    CotizacionEdt[]
  cotizacion       Cotizacion      @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)

  @@unique([cotizacionId, nombre])
  @@index([cotizacionId, orden])
  @@map("cotizacion_fase")
}

model CotizacionPlantillaImport {
  id               String     @id
  cotizacionId     String
  plantillaId      String
  tipoImportacion  String
  fechaImportacion DateTime   @default(now())
  usuarioId        String
  cotizacion       Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  plantilla        Plantilla  @relation(fields: [plantillaId], references: [id], onDelete: Cascade)
  user             User       @relation(fields: [usuarioId], references: [id])

  @@index([cotizacionId, fechaImportacion])
  @@index([plantillaId, tipoImportacion])
  @@map("cotizacion_plantilla_import")
}

model CotizacionTarea {
  id                          String                        @id
  nombre                      String
  descripcion                 String?
  fechaInicio                 DateTime
  fechaFin                    DateTime
  horasEstimadas              Decimal?                      @db.Decimal(10, 2)
  estado                      EstadoTarea                   @default(pendiente)
  prioridad                   PrioridadTarea                @default(media)
  dependenciaId               String?
  responsableId               String?
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime
  cotizacionServicioItemId    String?
  cotizacionActividadId       String
  duracionHoras               Decimal?                      @db.Decimal(10, 2)
  esHito                      Boolean                       @default(false)
  orden                       Int                           @default(0)
  dependenciasComoDependiente CotizacionDependenciasTarea[] @relation("dependenciasCotizacionTareaDependiente")
  dependenciasComoOrigen      CotizacionDependenciasTarea[] @relation("dependenciasCotizacionTareaOrigen")
  cotizacionActividad         CotizacionActividad           @relation(fields: [cotizacionActividadId], references: [id], onDelete: Cascade)
  cotizacionServicioItem      CotizacionServicioItem?       @relation(fields: [cotizacionServicioItemId], references: [id])
  tareaPadre                  CotizacionTarea?              @relation("cotizacionTareaHijas", fields: [dependenciaId], references: [id])
  tareasHijas                 CotizacionTarea[]             @relation("cotizacionTareaHijas")
  user                        User?                         @relation(fields: [responsableId], references: [id])

  @@index([cotizacionActividadId, estado])
  @@index([cotizacionServicioItemId])
  @@index([dependenciaId])
  @@index([responsableId, fechaFin])
  @@map("cotizacion_tarea")
}

model CotizacionVersion {
  id           String     @id
  cotizacionId String
  version      Int
  nombre       String
  descripcion  String?
  estado       String     @default("borrador")
  snapshot     String
  cambios      String?
  motivoCambio String?
  usuarioId    String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  cotizacion   Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [usuarioId], references: [id])

  @@unique([cotizacionId, version])
  @@index([cotizacionId, version])
  @@index([estado, createdAt])
  @@map("cotizacion_version")
}

model CrmActividad {
  id             String         @id
  oportunidadId  String
  tipo           String
  descripcion    String
  fecha          DateTime
  resultado      String?
  notas          String?
  usuarioId      String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  crmOportunidad CrmOportunidad @relation(fields: [oportunidadId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [usuarioId], references: [id])

  @@index([oportunidadId, fecha])
  @@map("crm_actividad")
}

model CrmCompetidorLicitacion {
  id                 String     @id
  cotizacionId       String
  nombreEmpresa      String
  contacto           String?
  telefono           String?
  email              String?
  propuestaEconomica Float?
  propuestaTecnica   String?
  fortalezas         String?
  debilidades        String?
  precioVsNuestro    String?
  resultado          String?
  razonPerdida       String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime
  cotizacion         Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)

  @@index([cotizacionId])
  @@map("crm_competidor_licitacion")
}

model CrmContactoCliente {
  id                  String    @id
  clienteId           String
  nombre              String
  cargo               String?
  email               String?
  telefono            String?
  celular             String?
  esDecisionMaker     Boolean   @default(false)
  areasInfluencia     String?
  relacionComercial   String?
  fechaUltimoContacto DateTime?
  notas               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  cliente             Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId, esDecisionMaker])
  @@map("crm_contacto_cliente")
}

model CrmHistorialProyecto {
  id                  String      @id
  clienteId           String
  proyectoId          String?
  cotizacionId        String?
  nombreProyecto      String
  tipoProyecto        String
  sector              String?
  complejidad         String?
  valorContrato       Float?
  margenObtenido      Float?
  duracionDias        Int?
  fechaInicio         DateTime?
  fechaFin            DateTime?
  fechaAdjudicacion   DateTime?
  calificacionCliente Int?
  retroalimentacion   String?
  exitos              String?
  problemas           String?
  recomendaciones     String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime
  cliente             Cliente     @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  cotizacion          Cotizacion? @relation(fields: [cotizacionId], references: [id])
  proyecto            Proyecto?   @relation(fields: [proyectoId], references: [id])

  @@index([clienteId, fechaInicio])
  @@index([tipoProyecto, sector])
  @@map("crm_historial_proyecto")
}

model CrmMetricaComercial {
  id                    String   @id
  usuarioId             String
  periodo               String
  cotizacionesGeneradas Int      @default(0)
  cotizacionesAprobadas Int      @default(0)
  proyectosCerrados     Int      @default(0)
  valorTotalVendido     Float    @default(0)
  margenTotalObtenido   Float    @default(0)
  tiempoPromedioCierre  Float?
  tasaConversion        Float?
  valorPromedioProyecto Float?
  llamadasRealizadas    Int      @default(0)
  reunionesAgendadas    Int      @default(0)
  propuestasEnviadas    Int      @default(0)
  emailsEnviados        Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime
  user                  User     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, periodo])
  @@index([periodo])
  @@map("crm_metrica_comercial")
}

model CrmOportunidad {
  id                  String            @id
  clienteId           String
  nombre              String
  descripcion         String?
  valorEstimado       Float?
  probabilidad        Int               @default(0)
  fechaCierreEstimada DateTime?
  fuente              String?
  prioridad           String            @default("media")
  comercialId         String?
  responsableId       String?
  fechaUltimoContacto DateTime?
  notas               String?
  competencia         String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime
  cotizacionId        String?           @unique
  proyectoId          String?
  estado              EstadoOportunidad @default(inicio)

  // Campos para Feedback de Mejora (cuando se pierde)
  fechaCierre       DateTime? // Fecha real de cierre (ganada o perdida)
  motivoPerdida     String? // Razón por la que se perdió
  competidorGanador String? // Competidor que ganó el concurso
  aprendizajes      String? // Lecciones aprendidas

  crmActividad CrmActividad[]
  cliente      Cliente        @relation(fields: [clienteId], references: [id])
  comercial    User?          @relation("CrmOportunidadComercial", fields: [comercialId], references: [id])
  cotizacion   Cotizacion?    @relation(fields: [cotizacionId], references: [id])
  proyecto     Proyecto?      @relation(fields: [proyectoId], references: [id])
  responsable  User?          @relation("CrmOportunidadResponsable", fields: [responsableId], references: [id])

  @@index([clienteId, estado])
  @@index([comercialId, fechaCierreEstimada])
  @@map("crm_oportunidad")
}

model DependenciasTarea {
  id                 String          @id
  tipo               TipoDependencia @default(finish_to_start)
  tareaOrigenId      String
  tareaDependienteId String
  createdAt          DateTime        @default(now())
  tareaDependiente   Tarea           @relation("dependenciasTareaDependiente", fields: [tareaDependienteId], references: [id], onDelete: Cascade)
  tareaOrigen        Tarea           @relation("dependenciasTareaOrigen", fields: [tareaOrigenId], references: [id], onDelete: Cascade)

  @@unique([tareaOrigenId, tareaDependienteId])
  @@map("dependencias_tarea")
}

model DiaCalendario {
  id                  String            @id
  calendarioLaboralId String
  diaSemana           DiaSemana
  esLaborable         Boolean           @default(true)
  horaInicioManana    String?
  horaFinManana       String?
  horaInicioTarde     String?
  horaFinTarde        String?
  horasTotales        Float?
  calendarioLaboral   CalendarioLaboral @relation(fields: [calendarioLaboralId], references: [id], onDelete: Cascade)

  @@unique([calendarioLaboralId, diaSemana])
  @@map("dia_calendario")
}

model Edt {
  id                                 String                               @id(map: "CategoriaServicio_pkey") @default(cuid())
  nombre                             String                               @unique(map: "CategoriaServicio_nombre_key")
  createdAt                          DateTime                             @default(now())
  updatedAt                          DateTime                             @updatedAt
  descripcion                        String?
  faseDefaultId                      String?
  catalogoServicio                   CatalogoServicio[]
  cotizacionServicio                 CotizacionServicio[]                 @relation("CotizacionServicioEdt")
  cotizacionServicioItem             CotizacionServicioItem[]             @relation("CotizacionServicioItemEdt")
  registroHoras                      RegistroHoras[]
  cotizacionEdt                      CotizacionEdt[]
  faseDefault                        FaseDefault?                         @relation(fields: [faseDefaultId], references: [id], map: "CategoriaServicio_faseDefaultId_fkey")
  proyectoEdt                        ProyectoEdt[]
  proyectoServicioCotizado           ProyectoServicioCotizado[]           @relation("ProyectoServicioCotizadoEdt")
  proyectoServicioCotizadoItem       ProyectoServicioCotizadoItem[]       @relation("ProyectoServicioCotizadoItemEdt")
  plantillaServicioIndependiente     PlantillaServicioIndependiente[]     @relation("PlantillaServicioIndependienteEdt")
  plantillaServicioItemIndependiente PlantillaServicioItemIndependiente[] @relation("PlantillaServicioItemIndependienteEdt")

  @@map("edt")
}

model ExcepcionCalendario {
  id                  String            @id
  calendarioLaboralId String
  fecha               DateTime
  tipo                TipoExcepcion
  nombre              String
  descripcion         String?
  horaInicio          String?
  horaFin             String?
  horasTotales        Float?
  calendarioLaboral   CalendarioLaboral @relation(fields: [calendarioLaboralId], references: [id], onDelete: Cascade)

  @@unique([calendarioLaboralId, fecha])
  @@map("excepcion_calendario")
}

model FaseDefault {
  id           String   @id
  nombre       String   @unique
  descripcion  String?
  orden        Int      @default(0)
  activo       Boolean  @default(true)
  duracionDias Int
  color        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  edt          Edt[]

  @@index([activo])
  @@index([orden])
  @@map("fase_default")
}

model MetricaComercial {
  id                    String   @id
  usuarioId             String
  periodo               String
  tipo                  String
  cotizacionesGeneradas Int      @default(0)
  cotizacionesAprobadas Int      @default(0)
  proyectosCerrados     Int      @default(0)
  valorTotalVendido     Float    @default(0)
  margenTotalObtenido   Float    @default(0)
  tiempoPromedioCierre  Float?
  tasaConversion        Float?
  valorPromedioProyecto Float?
  llamadasRealizadas    Int      @default(0)
  reunionesAgendadas    Int      @default(0)
  propuestasEnviadas    Int      @default(0)
  emailsEnviados        Int      @default(0)
  oportunidadesCreadas  Int      @default(0)
  oportunidadesGanadas  Int      @default(0)
  oportunidadesPerdidas Int      @default(0)
  actividadesRealizadas Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime
  user                  User     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, periodo, tipo])
  @@index([periodo, tipo])
  @@index([usuarioId, tipo])
  @@map("metrica_comercial")
}

model Notificacion {
  id           String                @id
  titulo       String
  mensaje      String
  tipo         TipoNotificacion      @default(info)
  prioridad    PrioridadNotificacion @default(media)
  usuarioId    String
  entidadTipo  String?
  entidadId    String?
  leida        Boolean               @default(false)
  fechaLectura DateTime?
  accionUrl    String?
  accionTexto  String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime
  user         User                  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([entidadTipo, entidadId])
  @@index([usuarioId, leida, createdAt(sort: Desc)])
  @@map("notificaciones")
}

model Permission {
  id                 String           @id
  name               String           @unique
  description        String?
  resource           String
  action             String
  isSystemPermission Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime
  userPermissions    UserPermission[]

  @@index([resource, action])
  @@map("permissions")
}

model CatalogoCondicion {
  id                                  String                                @id @default(cuid())
  codigo                              String                                @unique
  descripcion                         String
  categoriaId                         String?
  tipo                                String?
  activo                              Boolean                               @default(true)
  orden                               Int                                   @default(0)
  createdAt                           DateTime                              @default(now())
  updatedAt                           DateTime                              @updatedAt
  categoria                           CategoriaCondicion?                   @relation(fields: [categoriaId], references: [id])
  cotizacionCondiciones               CotizacionCondicion[]
  plantillaCondicionItemIndependiente PlantillaCondicionItemIndependiente[]
  plantillaCondicion                  PlantillaCondicion[]
  proyectoCondicion                   ProyectoCondicion[]

  @@index([categoriaId, tipo, activo])
  @@map("catalogo_condicion")
}

model PlantillaDuracionCronograma {
  id               String   @id
  nivel            String   @unique
  duracionDias     Float
  horasPorDia      Int      @default(8)
  bufferPorcentaje Float    @default(10.0)
  activo           Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime

  @@map("plantilla_duracion_cronograma")
}

model PlantillaEquipoIndependiente {
  id                               String                             @id
  nombre                           String
  descripcion                      String?
  estado                           String                             @default("borrador")
  totalInterno                     Float                              @default(0)
  totalCliente                     Float                              @default(0)
  descuento                        Float                              @default(0)
  grandTotal                       Float                              @default(0)
  createdAt                        DateTime                           @default(now())
  updatedAt                        DateTime
  plantillaEquipoItemIndependiente PlantillaEquipoItemIndependiente[]

  @@map("plantilla_equipo_independiente")
}

model PlantillaEquipoItemIndependiente {
  id                           String                       @id
  plantillaEquipoId            String
  catalogoEquipoId             String?
  codigo                       String
  descripcion                  String
  categoria                    String
  unidad                       String
  marca                        String
  precioLista                  Float
  precioInterno                Float
  factorCosto                  Float                        @default(1.00)
  factorVenta                  Float                        @default(1.15)
  precioCliente                Float
  cantidad                     Float
  costoInterno                 Float
  costoCliente                 Float
  createdAt                    DateTime                     @default(now())
  updatedAt                    DateTime
  catalogoEquipo               CatalogoEquipo?              @relation(fields: [catalogoEquipoId], references: [id])
  plantillaEquipoIndependiente PlantillaEquipoIndependiente @relation(fields: [plantillaEquipoId], references: [id], onDelete: Cascade)

  @@map("plantilla_equipo_item_independiente")
}

model CatalogoExclusion {
  id                                  String                                @id @default(cuid())
  codigo                              String                                @unique
  descripcion                         String
  categoriaId                         String?
  activo                              Boolean                               @default(true)
  orden                               Int                                   @default(0)
  createdAt                           DateTime                              @default(now())
  updatedAt                           DateTime                              @updatedAt
  categoria                           CategoriaExclusion?                   @relation(fields: [categoriaId], references: [id])
  cotizacionExclusiones               CotizacionExclusion[]
  plantillaExclusionItemIndependiente PlantillaExclusionItemIndependiente[]
  plantillaExclusion                  PlantillaExclusion[]
  proyectoExclusion                   ProyectoExclusion[]

  @@index([categoriaId, activo])
  @@map("catalogo_exclusion")
}

model PlantillaGastoIndependiente {
  id                              String                            @id
  nombre                          String
  descripcion                     String?
  estado                          String                            @default("borrador")
  totalInterno                    Float                             @default(0)
  totalCliente                    Float                             @default(0)
  descuento                       Float                             @default(0)
  grandTotal                      Float                             @default(0)
  createdAt                       DateTime                          @default(now())
  updatedAt                       DateTime
  plantillaGastoItemIndependiente PlantillaGastoItemIndependiente[]

  @@map("plantilla_gasto_independiente")
}

model PlantillaGastoItemIndependiente {
  id                          String                      @id
  plantillaGastoId            String
  nombre                      String
  descripcion                 String?
  cantidad                    Float
  precioUnitario              Float
  factorSeguridad             Float                       @default(1.0)
  margen                      Float                       @default(1.0)
  costoInterno                Float
  costoCliente                Float
  createdAt                   DateTime                    @default(now())
  updatedAt                   DateTime
  plantillaGastoIndependiente PlantillaGastoIndependiente @relation(fields: [plantillaGastoId], references: [id], onDelete: Cascade)

  @@map("plantilla_gasto_item_independiente")
}

model PlantillaServicioIndependiente {
  id                                 String                               @id
  nombre                             String
  descripcion                        String?
  edtId                              String?
  estado                             String                               @default("borrador")
  totalInterno                       Float                                @default(0)
  totalCliente                       Float                                @default(0)
  descuento                          Float                                @default(0)
  grandTotal                         Float                                @default(0)
  createdAt                          DateTime                             @default(now())
  updatedAt                          DateTime
  edt                                Edt?                                 @relation("PlantillaServicioIndependienteEdt", fields: [edtId], references: [id])
  plantillaServicioItemIndependiente PlantillaServicioItemIndependiente[]

  @@map("plantilla_servicio_independiente")
}

model PlantillaServicioItemIndependiente {
  id                             String                         @id
  plantillaServicioId            String
  catalogoServicioId             String?
  unidadServicioId               String
  recursoId                      String
  edtId                          String?
  nombre                         String
  descripcion                    String
  unidadServicioNombre           String
  recursoNombre                  String
  formula                        String
  horaBase                       Float?
  horaRepetido                   Float?
  horaUnidad                     Float?
  horaFijo                       Float?
  costoHora                      Float
  cantidad                       Int
  horaTotal                      Float
  factorSeguridad                Float
  margen                         Float
  costoInterno                   Float
  costoCliente                   Float
  orden                          Int?                           @default(0)
  createdAt                      DateTime                       @default(now())
  updatedAt                      DateTime
  catalogoServicio               CatalogoServicio?              @relation(fields: [catalogoServicioId], references: [id])
  edt                            Edt?                           @relation("PlantillaServicioItemIndependienteEdt", fields: [edtId], references: [id])
  plantillaServicioIndependiente PlantillaServicioIndependiente @relation(fields: [plantillaServicioId], references: [id], onDelete: Cascade)
  recurso                        Recurso                        @relation(fields: [recursoId], references: [id])
  unidadServicio                 UnidadServicio                 @relation(fields: [unidadServicioId], references: [id])

  @@map("plantilla_servicio_item_independiente")
}

model PlantillaCondicionIndependiente {
  id                                  String                                @id @default(cuid())
  nombre                              String
  descripcion                         String?
  activo                              Boolean                               @default(true)
  createdAt                           DateTime                              @default(now())
  updatedAt                           DateTime                              @updatedAt
  plantillaCondicionItemIndependiente PlantillaCondicionItemIndependiente[]

  @@map("plantilla_condicion_independiente")
}

model PlantillaCondicionItemIndependiente {
  id                              String                          @id @default(cuid())
  plantillaCondicionId            String
  catalogoCondicionId             String?
  descripcion                     String
  tipo                            String?
  orden                           Int                             @default(0)
  createdAt                       DateTime                        @default(now())
  updatedAt                       DateTime                        @updatedAt
  catalogoCondicion               CatalogoCondicion?              @relation(fields: [catalogoCondicionId], references: [id])
  plantillaCondicionIndependiente PlantillaCondicionIndependiente @relation(fields: [plantillaCondicionId], references: [id], onDelete: Cascade)

  @@index([plantillaCondicionId, orden])
  @@map("plantilla_condicion_item_independiente")
}

model PlantillaExclusionIndependiente {
  id                                  String                                @id @default(cuid())
  nombre                              String
  descripcion                         String?
  activo                              Boolean                               @default(true)
  createdAt                           DateTime                              @default(now())
  updatedAt                           DateTime                              @updatedAt
  plantillaExclusionItemIndependiente PlantillaExclusionItemIndependiente[]

  @@map("plantilla_exclusion_independiente")
}

model PlantillaExclusionItemIndependiente {
  id                              String                          @id @default(cuid())
  plantillaExclusionId            String
  catalogoExclusionId             String?
  descripcion                     String
  orden                           Int                             @default(0)
  createdAt                       DateTime                        @default(now())
  updatedAt                       DateTime                        @updatedAt
  catalogoExclusion               CatalogoExclusion?              @relation(fields: [catalogoExclusionId], references: [id])
  plantillaExclusionIndependiente PlantillaExclusionIndependiente @relation(fields: [plantillaExclusionId], references: [id], onDelete: Cascade)

  @@index([plantillaExclusionId, orden])
  @@map("plantilla_exclusion_item_independiente")
}

model ProyectoActividad {
  id                   String             @id
  proyectoEdtId        String
  proyectoCronogramaId String
  nombre               String
  orden                Int                @default(0)
  responsableId        String?
  fechaInicioPlan      DateTime
  fechaFinPlan         DateTime
  fechaInicioReal      DateTime?
  fechaFinReal         DateTime?
  estado               EstadoActividad    @default(pendiente)
  porcentajeAvance     Int                @default(0)
  horasPlan            Decimal?           @db.Decimal(10, 2)
  horasReales          Decimal            @default(0) @db.Decimal(10, 2)
  descripcion          String?
  prioridad            PrioridadEdt       @default(media)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  proyectoCronograma   ProyectoCronograma @relation(fields: [proyectoCronogramaId], references: [id], onDelete: Cascade)
  proyectoEdt          ProyectoEdt        @relation(fields: [proyectoEdtId], references: [id], onDelete: Cascade)
  user                 User?              @relation(fields: [responsableId], references: [id])
  proyectoTarea        ProyectoTarea[]

  @@index([proyectoEdtId, proyectoCronogramaId])
  @@index([proyectoEdtId, proyectoCronogramaId, orden])
  @@map("proyecto_actividad")
}

model ProyectoCronograma {
  id                       String              @id
  proyectoId               String
  tipo                     String
  nombre                   String
  copiadoDesdeCotizacionId String?             @unique
  esBaseline               Boolean             @default(false)
  version                  Int                 @default(1)
  bloqueado                Boolean             @default(false)
  createdAt                DateTime            @default(now())
  updatedAt                DateTime
  proyectoActividad        ProyectoActividad[]
  proyecto                 Proyecto            @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  proyectoEdt              ProyectoEdt[]
  proyectoFase             ProyectoFase[]
  proyectoTarea            ProyectoTarea[]

  @@unique([proyectoId, tipo])
  @@index([proyectoId, tipo])
  @@map("proyecto_cronograma")
}

model ProyectoDependenciasTarea {
  id                 String          @id
  tipo               TipoDependencia @default(finish_to_start)
  tareaOrigenId      String
  tareaDependienteId String
  lagMinutos         Int             @default(0)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  tareaDependiente   ProyectoTarea   @relation("dependenciasTareaDependiente", fields: [tareaDependienteId], references: [id], onDelete: Cascade)
  tareaOrigen        ProyectoTarea   @relation("dependenciasTareaOrigen", fields: [tareaOrigenId], references: [id], onDelete: Cascade)

  @@unique([tareaOrigenId, tareaDependienteId])
  @@map("proyecto_dependencias_tarea")
}

model ProyectoEdt {
  id                   String               @id
  proyectoId           String
  edtId                String
  fechaInicioPlan      DateTime?
  fechaFinPlan         DateTime?
  horasPlan            Decimal?             @default(0) @db.Decimal(10, 2)
  fechaInicioReal      DateTime?
  fechaFinReal         DateTime?
  horasReales          Decimal              @default(0) @db.Decimal(10, 2)
  estado               EstadoEdt            @default(planificado)
  responsableId        String?
  porcentajeAvance     Int                  @default(0)
  descripcion          String?
  prioridad            PrioridadEdt         @default(media)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime
  nombre               String
  orden                Int                  @default(0)
  proyectoCronogramaId String
  proyectoFaseId       String?
  registroHoras        RegistroHoras[]
  proyectoActividad    ProyectoActividad[]
  edt                  Edt                  @relation(fields: [edtId], references: [id])
  proyectoCronograma   ProyectoCronograma   @relation(fields: [proyectoCronogramaId], references: [id], onDelete: Cascade)
  proyectoFase         ProyectoFase?        @relation(fields: [proyectoFaseId], references: [id])
  proyecto             Proyecto             @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  user                 User?                @relation(fields: [responsableId], references: [id])
  proyectoTarea        ProyectoTarea[]
  registrosCampo       RegistroHorasCampo[]

  @@unique([proyectoId, proyectoCronogramaId, nombre])
  @@index([estado, fechaFinPlan])
  @@index([proyectoId, proyectoCronogramaId, orden])
  @@index([responsableId, estado])
  @@map("proyecto_edt")
}

model ProyectoFase {
  id                   String             @id
  proyectoId           String
  proyectoCronogramaId String
  nombre               String
  descripcion          String?
  orden                Int                @default(0)
  fechaInicioPlan      DateTime?
  fechaFinPlan         DateTime?
  fechaInicioReal      DateTime?
  fechaFinReal         DateTime?
  estado               EstadoFase         @default(planificado)
  porcentajeAvance     Int                @default(0)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  proyectoEdt          ProyectoEdt[]
  proyectoCronograma   ProyectoCronograma @relation(fields: [proyectoCronogramaId], references: [id], onDelete: Cascade)
  proyecto             Proyecto           @relation(fields: [proyectoId], references: [id], onDelete: Cascade)

  @@unique([proyectoId, proyectoCronogramaId, nombre])
  @@index([proyectoId, proyectoCronogramaId, orden])
  @@map("proyecto_fase")
}

model ProyectoSubtarea {
  id                   String        @id
  nombre               String
  descripcion          String?
  fechaInicio          DateTime
  fechaFin             DateTime
  fechaInicioReal      DateTime?
  fechaFinReal         DateTime?
  estado               EstadoTarea   @default(pendiente)
  porcentajeCompletado Int           @default(0)
  horasEstimadas       Decimal?      @db.Decimal(10, 2)
  horasReales          Decimal?      @default(0) @db.Decimal(10, 2)
  proyectoTareaId      String
  asignadoId           String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime
  user                 User?         @relation(fields: [asignadoId], references: [id])
  proyectoTarea        ProyectoTarea @relation(fields: [proyectoTareaId], references: [id], onDelete: Cascade)

  @@map("proyecto_subtarea")
}

model ProyectoTarea {
  id                          String                      @id
  proyectoEdtId               String
  proyectoCronogramaId        String
  nombre                      String
  descripcion                 String?
  orden                       Int                         @default(0)
  fechaInicio                 DateTime
  fechaFin                    DateTime
  fechaInicioReal             DateTime?
  fechaFinReal                DateTime?
  horasEstimadas              Decimal?                    @db.Decimal(10, 2)
  horasReales                 Decimal                     @default(0) @db.Decimal(10, 2)
  personasEstimadas           Int                         @default(1)
  estado                      EstadoTarea                 @default(pendiente)
  prioridad                   PrioridadTarea              @default(media)
  porcentajeCompletado        Int                         @default(0)
  dependenciaId               String?
  responsableId               String?
  creadoPorId                 String?
  proyectoActividadId         String?
  recursoId                   String?
  createdAt                   DateTime                    @default(now())
  updatedAt                   DateTime
  registroHoras               RegistroHoras[]
  dependenciasComoDependiente ProyectoDependenciasTarea[] @relation("dependenciasTareaDependiente")
  dependenciasComoOrigen      ProyectoDependenciasTarea[] @relation("dependenciasTareaOrigen")
  proyectoSubtarea            ProyectoSubtarea[]
  tareaPadre                  ProyectoTarea?              @relation("proyectoTareaHijas", fields: [dependenciaId], references: [id])
  tareasHijas                 ProyectoTarea[]             @relation("proyectoTareaHijas")
  proyectoActividad           ProyectoActividad?          @relation(fields: [proyectoActividadId], references: [id])
  proyectoCronograma          ProyectoCronograma          @relation(fields: [proyectoCronogramaId], references: [id], onDelete: Cascade)
  proyectoEdt                 ProyectoEdt                 @relation(fields: [proyectoEdtId], references: [id], onDelete: Cascade)
  user                        User?                       @relation("TareaResponsable", fields: [responsableId], references: [id])
  creadoPor                   User?                       @relation("TareaCreadaPor", fields: [creadoPorId], references: [id])
  recurso                     Recurso?                    @relation(fields: [recursoId], references: [id], onDelete: SetNull)
  registrosCampoTarea         RegistroHorasCampoTarea[]

  @@index([creadoPorId])
  @@index([recursoId])
  @@index([dependenciaId])
  @@index([proyectoActividadId])
  @@index([proyectoActividadId, orden])
  @@index([proyectoEdtId, estado])
  @@index([proyectoEdtId, orden])
  @@index([responsableId, fechaFin])
  @@map("proyecto_tarea")
}

model RegistroProgreso {
  id                   String    @id
  fecha                DateTime  @default(now())
  horasTrabajadas      Decimal   @db.Decimal(10, 2)
  descripcion          String?
  porcentajeCompletado Int?
  tareaId              String?
  subtareaId           String?
  usuarioId            String
  createdAt            DateTime  @default(now())
  subtarea             Subtarea? @relation(fields: [subtareaId], references: [id], onDelete: Cascade)
  tarea                Tarea?    @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  user                 User      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("registros_progreso")
}

model Subtarea {
  id                   String             @id
  nombre               String
  descripcion          String?
  fechaInicio          DateTime
  fechaFin             DateTime
  fechaInicioReal      DateTime?
  fechaFinReal         DateTime?
  estado               EstadoTarea        @default(pendiente)
  porcentajeCompletado Int                @default(0)
  horasEstimadas       Decimal?           @db.Decimal(10, 2)
  horasReales          Decimal?           @default(0) @db.Decimal(10, 2)
  tareaId              String
  asignadoId           String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  registrosProgreso    RegistroProgreso[]
  user                 User?              @relation(fields: [asignadoId], references: [id])
  tarea                Tarea              @relation(fields: [tareaId], references: [id], onDelete: Cascade)

  @@map("subtareas")
}

model Tarea {
  id                          String                   @id
  nombre                      String
  descripcion                 String?
  fechaInicio                 DateTime
  fechaFin                    DateTime
  fechaInicioReal             DateTime?
  fechaFinReal                DateTime?
  estado                      EstadoTarea              @default(pendiente)
  prioridad                   PrioridadTarea           @default(media)
  porcentajeCompletado        Int                      @default(0)
  horasEstimadas              Decimal?                 @db.Decimal(10, 2)
  horasReales                 Decimal?                 @default(0) @db.Decimal(10, 2)
  proyectoServicioId          String
  responsableId               String?
  createdAt                   DateTime                 @default(now())
  updatedAt                   DateTime
  asignacionesRecurso         AsignacionRecurso[]
  dependenciasComoDependiente DependenciasTarea[]      @relation("dependenciasTareaDependiente")
  dependenciasComoOrigen      DependenciasTarea[]      @relation("dependenciasTareaOrigen")
  registrosProgreso           RegistroProgreso[]
  subtareas                   Subtarea[]
  proyectoServicioCotizado    ProyectoServicioCotizado @relation(fields: [proyectoServicioId], references: [id], onDelete: Cascade)
  user                        User?                    @relation(fields: [responsableId], references: [id])

  @@map("tareas")
}

model UserPermission {
  id           String     @id
  userId       String
  permissionId String
  type         String
  createdBy    String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([permissionId])
  @@index([userId])
  @@map("user_permissions")
}

// Configuración general del sistema (singleton - solo un registro)
model ConfiguracionGeneral {
  id             String   @id @default("default")
  tipoCambio     Decimal  @default(3.75) @db.Decimal(10, 4) // PEN a USD
  horasSemanales Int      @default(48) // Horas laborales por semana
  diasLaborables Int      @default(5) // Días laborables por semana (L-V)
  semanasxMes    Int      @default(4) // Semanas por mes para cálculo
  horasMensuales Int      @default(192) // Calculado: horasSemanales * semanasxMes
  agenteLimiteMensualUsd Float @default(25) // Limite mensual de gasto del agente IA (USD)
  updatedAt      DateTime @updatedAt
  updatedBy      String?
  user           User?    @relation(fields: [updatedBy], references: [id])

  @@map("configuracion_general")
}

// Configuración de columnas y permisos del catálogo de equipos por vista
model ConfiguracionCatalogoColumnas {
  id        String   @id // 'admin' | 'comercial' | 'logistica' | 'proyectos'
  columnas  Json     // Array de column keys visibles
  permisos  Json     // { canCreate, canEdit, canDelete, canImport, canExport }
  updatedAt DateTime @updatedAt

  @@map("configuracion_catalogo_columnas")
}

enum DiaSemana {
  lunes
  martes
  miercoles
  jueves
  viernes
  sabado
  domingo
}

enum EstadoActividad {
  pendiente
  en_progreso
  completada
  pausada
  cancelada
}

enum EstadoCotizacion {
  borrador
  enviada
  aprobada
  rechazada
}

enum EstadoCotizacionProveedor {
  pendiente
  solicitado
  cotizado
  rechazado
  seleccionado
}

enum EstadoEdt {
  planificado
  en_progreso
  detenido
  completado
  cancelado
  pausado
}

enum EstadoEntregaItem {
  pendiente
  en_proceso
  parcial
  entregado
  retrasado
  cancelado
}

enum EstadoEquipo {
  pendiente
  revisado_tecnico
  aprobado_coordinador
  aprobado_gestor
  en_lista
  comprado
  reemplazado
  entregado
}

enum EstadoEquipoItem {
  pendiente
  en_lista
  reemplazado
  descartado
}

enum EstadoFase {
  planificado
  en_progreso
  completado
  pausado
  cancelado
}

enum EstadoListaEquipo {
  borrador
  enviada
  por_revisar
  por_cotizar
  por_validar
  por_aprobar
  aprobada
  rechazada
  completada
}

enum EstadoListaItem {
  borrador
  por_revisar
  por_cotizar
  por_validar
  por_aprobar
  aprobado
  rechazado
}

enum EstadoOportunidad {
  inicio
  contacto_cliente
  validacion_tecnica // Propuesta: alcance y recursos
  validacion_comercial // Propuesta: costeo, margen, condiciones
  negociacion // Post-envío de cotización
  seguimiento_proyecto // Ganada: seguimiento de ejecución
  feedback_mejora // Perdida: motivo, competidor, aprendizajes
  cerrada_ganada // Legacy
  cerrada_perdida // Legacy
}

enum EstadoPedido {
  borrador
  enviado
  atendido
  parcial
  entregado
  cancelado
}

enum EstadoPedidoItem {
  pendiente
  atendido
  parcial
  entregado
  cancelado
}

enum EstadoTarea {
  pendiente
  en_progreso
  completada
  pausada
  cancelada
}

enum OrigenListaItem {
  cotizado
  nuevo
  reemplazo
}

enum OrigenTrabajo {
  oficina
  campo
}

enum EstadoRegistroCampo {
  iniciado   // Jornada comenzada pero no cerrada
  pendiente  // Jornada cerrada, esperando aprobación
  aprobado
  rechazado
}

enum PlantillaTipo {
  completa
  equipos
  servicios
  gastos
}

enum PrioridadEdt {
  baja
  media
  alta
  critica
}

enum PrioridadNotificacion {
  baja
  media
  alta
  critica
}

enum PrioridadTarea {
  baja
  media
  alta
  critica
}

enum ProyectoEstado {
  creado // 1. Creado por Comercial (desde cotización aprobada)
  en_planificacion // 2. Elaboración del cronograma
  listas_pendientes // 3. Elaboración de listas técnicas
  listas_aprobadas // 4. Listas aprobadas
  pedidos_creados // 5. Pedidos de compra creados
  en_ejecucion // 6. En campo / ejecución
  en_cierre // 7. Proceso de cierre
  cerrado // 8. Proyecto cerrado
  pausado // Estado especial: pausado
  cancelado // Estado especial: cancelado
}

enum Role {
  colaborador
  comercial
  presupuestos
  proyectos
  coordinador
  logistico
  gestor
  gerente
  seguridad
  admin
  administracion
}

enum TipoDependencia {
  finish_to_start
  start_to_start
  finish_to_finish
  start_to_finish
}

enum TipoExcepcion {
  feriado
  dia_laboral_extra
  dia_no_laboral
}

enum TipoNotificacion {
  info
  warning
  success
  error
}

enum TipoRecurso {
  individual
  cuadrilla
}

enum OrigenRecurso {
  propio
  externo
}

enum OrigenPartida {
  equipo
  servicio
  gasto
  libre
}

enum EstadoValorizacion {
  borrador
  enviada
  observada
  corregida
  aprobada_cliente
  facturada
  pagada
  anulada
}

enum EstadoCuentaCobrar {
  pendiente
  parcial
  pagada
  vencida
  anulada
}

enum EstadoCuentaPagar {
  pendiente_documentos
  pendiente
  parcial
  pagada
  vencida
  anulada
}

model RoleSectionAccess {
  id         String   @id @default(cuid())
  role       Role
  sectionKey String
  hasAccess  Boolean  @default(true)
  updatedBy  String?
  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())

  @@unique([role, sectionKey])
  @@index([role])
  @@map("role_section_access")
}

// ======================
// 💰 Centro de Costo y Hojas de Gastos
// ======================

model CentroCosto {
  id          String   @id @default(cuid())
  nombre      String
  tipo        String   // "departamento" | "administrativo"
  descripcion String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  hojas         HojaDeGastos[]
  ordenesCompra OrdenCompra[]

  @@index([tipo, activo])
  @@map("centro_costo")
}

// Imputación: proyectoId y centroCostoId son mutuamente excluyentes.
// Exactamente UNO debe estar presente: proyecto (para gastos de proyecto)
// o centroCosto (para gastos administrativos/departamento). Validación en API.
model HojaDeGastos {
  id                String    @id @default(cuid())
  numero            String    @unique
  proyectoId        String?
  centroCostoId     String?
  categoriaCosto    CategoriaCosto @default(gastos)
  empleadoId        String
  aprobadorId       String?
  motivo            String
  observaciones     String?
  requiereAnticipo  Boolean   @default(false)
  estado            String    @default("borrador")
  rechazadoEn       String?
  comentarioRechazo String?
  montoAnticipo     Float     @default(0)
  montoDepositado   Float     @default(0)
  montoGastado      Float     @default(0)
  saldo             Float     @default(0)
  fechaEnvio        DateTime?
  fechaAprobacion   DateTime?
  fechaDeposito     DateTime?
  fechaRendicion    DateTime?
  fechaValidacion   DateTime?
  fechaCierre       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime

  proyecto    Proyecto?    @relation(fields: [proyectoId], references: [id])
  centroCosto CentroCosto? @relation(fields: [centroCostoId], references: [id])
  empleado    User         @relation("HojaEmpleado", fields: [empleadoId], references: [id])
  aprobador   User?        @relation("HojaAprobador", fields: [aprobadorId], references: [id])
  lineas      GastoLinea[]
  adjuntos    HojaDeGastosAdjunto[]
  eventos     HojaDeGastosEvento[]

  @@index([proyectoId, estado])
  @@index([centroCostoId, estado])
  @@index([empleadoId, estado])
  @@map("hoja_de_gastos")
}

model HojaDeGastosEvento {
  id              String   @id @default(cuid())
  hojaDeGastosId  String
  tipo            String   // creado, enviado, aprobado, rechazado, depositado, rendido, validado, cerrado, adjunto_subido
  descripcion     String
  estadoAnterior  String?
  estadoNuevo     String?
  metadata        Json?
  usuarioId       String?
  creadoEn        DateTime @default(now())

  hojaDeGastos HojaDeGastos @relation(fields: [hojaDeGastosId], references: [id], onDelete: Cascade)
  usuario      User?        @relation("HojaEventoUsuario", fields: [usuarioId], references: [id])

  @@index([hojaDeGastosId])
  @@map("hoja_de_gastos_evento")
}

model HojaDeGastosAdjunto {
  id              String   @id @default(cuid())
  hojaDeGastosId  String
  nombreArchivo   String
  urlArchivo      String
  driveFileId     String?
  tipoArchivo     String?
  tamano          Int?
  tipo            String   @default("constancia_deposito")
  createdAt       DateTime @default(now())

  hojaDeGastos HojaDeGastos @relation(fields: [hojaDeGastosId], references: [id], onDelete: Cascade)

  @@index([hojaDeGastosId])
  @@map("hoja_de_gastos_adjunto")
}

model GastoLinea {
  id                String          @id @default(cuid())
  hojaDeGastosId    String
  categoriaGastoId  String?
  descripcion       String
  fecha             DateTime
  monto             Float
  moneda            String          @default("PEN")
  tipoComprobante   String?
  numeroComprobante String?
  proveedorNombre   String?
  proveedorRuc      String?
  observaciones     String?
  sunatVerificado       Boolean?
  conformidad           String?
  comentarioConformidad String?
  conformadoEn          DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime

  hojaDeGastos   HojaDeGastos    @relation(fields: [hojaDeGastosId], references: [id], onDelete: Cascade)
  categoriaGasto CategoriaGasto? @relation(fields: [categoriaGastoId], references: [id])
  adjuntos       GastoAdjunto[]

  @@index([hojaDeGastosId])
  @@map("gasto_linea")
}

model GastoAdjunto {
  id            String   @id @default(cuid())
  gastoLineaId  String
  nombreArchivo String
  urlArchivo    String
  driveFileId   String?
  tipoArchivo   String?
  tamano        Int?
  createdAt     DateTime @default(now())

  gastoLinea GastoLinea @relation(fields: [gastoLineaId], references: [id], onDelete: Cascade)

  @@index([gastoLineaId])
  @@map("gasto_adjunto")
}

// ======================
// 📋 Órdenes de Compra
// ======================

enum CategoriaCosto {
  equipos
  servicios
  gastos
}

enum EstadoOrdenCompra {
  borrador
  aprobada
  enviada
  confirmada
  parcial
  completada
  cancelada
}

// Imputación: proyectoId y centroCostoId son mutuamente excluyentes.
// Exactamente UNO debe estar presente. Validación en API.
model OrdenCompra {
  id                   String            @id @default(cuid())
  numero               String            @unique
  proveedorId          String
  centroCostoId        String?
  pedidoEquipoId       String?
  proyectoId           String?
  solicitanteId        String
  aprobadorId          String?
  categoriaCosto       CategoriaCosto    @default(equipos)
  estado               EstadoOrdenCompra @default(borrador)
  condicionPago        String            @default("contado")
  diasCredito          Int?
  moneda               String            @default("PEN")
  subtotal             Float             @default(0)
  igv                  Float             @default(0)
  total                Float             @default(0)
  lugarEntrega         String?
  contactoEntrega      String?
  observaciones        String?
  fechaEmision         DateTime          @default(now())
  fechaAprobacion      DateTime?
  fechaEnvio           DateTime?
  fechaConfirmacion    DateTime?
  fechaEntregaEstimada DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime

  proveedor    Proveedor        @relation(fields: [proveedorId], references: [id])
  centroCosto  CentroCosto?     @relation(fields: [centroCostoId], references: [id])
  pedidoEquipo PedidoEquipo?    @relation(fields: [pedidoEquipoId], references: [id])
  proyecto     Proyecto?        @relation(fields: [proyectoId], references: [id])
  solicitante     User              @relation("OCsolicitante", fields: [solicitanteId], references: [id])
  aprobador       User?             @relation("OCaprobador", fields: [aprobadorId], references: [id])
  items           OrdenCompraItem[]
  cuentasPorPagar CuentaPorPagar[]

  @@index([proveedorId, estado])
  @@index([centroCostoId, estado])
  @@index([estado, createdAt(sort: Desc)])
  @@map("orden_compra")
}

model OrdenCompraItem {
  id                 String   @id @default(cuid())
  ordenCompraId      String
  pedidoEquipoItemId String?
  listaEquipoItemId  String?
  codigo             String
  descripcion        String
  tipoItem           String   @default("equipo")
  unidad             String
  cantidad           Float
  precioUnitario     Float
  costoTotal         Float
  cantidadRecibida   Float    @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime

  ordenCompra      OrdenCompra       @relation(fields: [ordenCompraId], references: [id], onDelete: Cascade)
  pedidoEquipoItem PedidoEquipoItem? @relation(fields: [pedidoEquipoItemId], references: [id])
  listaEquipoItem  ListaEquipoItem?  @relation(fields: [listaEquipoItemId], references: [id])

  recepcionesPendientes RecepcionPendiente[]

  @@index([ordenCompraId])
  @@map("orden_compra_item")
}

model RecepcionPendiente {
  id                    String    @id @default(cuid())
  pedidoEquipoItemId    String
  ordenCompraItemId     String
  cantidadRecibida      Float
  fechaRecepcion        DateTime  @default(now())
  estado                String    @default("pendiente")
  confirmadoPorId       String?
  fechaConfirmacion     DateTime?
  entregadoPorId        String?
  fechaEntregaProyecto  DateTime?
  rechazadoPorId        String?
  fechaRechazo          DateTime?
  motivoRechazo         String?
  observaciones         String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  pedidoEquipoItem PedidoEquipoItem @relation(fields: [pedidoEquipoItemId], references: [id], onDelete: Cascade)
  ordenCompraItem  OrdenCompraItem  @relation(fields: [ordenCompraItemId], references: [id], onDelete: Cascade)
  confirmadoPor    User?            @relation("RecepcionConfirmador", fields: [confirmadoPorId], references: [id])
  entregadoPor     User?            @relation("RecepcionEntregador", fields: [entregadoPorId], references: [id])
  rechazadoPor     User?            @relation("RecepcionRechazador", fields: [rechazadoPorId], references: [id])

  @@index([pedidoEquipoItemId])
  @@index([ordenCompraItemId])
  @@index([estado])
  @@map("recepcion_pendiente")
}

// ======================
// 🏦 Cuentas Bancarias, CxC, CxP
// ======================

model CuentaBancaria {
  id            String   @id @default(cuid())
  nombreBanco   String
  numeroCuenta  String
  cci           String?
  tipo          String   @default("corriente") // corriente, ahorro
  moneda        String   @default("PEN")       // PEN, USD
  activa        Boolean  @default(true)
  descripcion   String?                        // alias: "BCP Soles Operaciones"
  createdAt     DateTime @default(now())
  updatedAt     DateTime

  pagosCobro PagoCobro[]
  pagosPagar PagoPagar[]

  @@index([activa, moneda])
  @@map("cuenta_bancaria")
}

model CuentaPorCobrar {
  id                String             @id @default(cuid())
  proyectoId        String
  clienteId         String
  valorizacionId    String?
  numeroDocumento   String?            // número de factura emitida
  descripcion       String?
  monto             Float
  moneda            String             @default("PEN")
  tipoCambio        Float?
  montoPagado       Float              @default(0) // calculado: SUM(pagosCobro.monto)
  saldoPendiente    Float              @default(0) // calculado: monto - montoPagado
  fechaEmision      DateTime
  fechaVencimiento  DateTime
  condicionPago     String?
  diasCredito       Int?
  metodoPago        String?
  bancoFinanciera   String?
  estado            EstadoCuentaCobrar @default(pendiente)
  observaciones     String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime

  proyecto     Proyecto      @relation(fields: [proyectoId], references: [id])
  cliente      Cliente       @relation(fields: [clienteId], references: [id])
  valorizacion Valorizacion? @relation(fields: [valorizacionId], references: [id])
  pagos        PagoCobro[]
  adjuntos     CxCAdjunto[]

  @@index([proyectoId, estado])
  @@index([clienteId, estado])
  @@index([estado, fechaVencimiento])
  @@map("cuenta_por_cobrar")
}

model PagoCobro {
  id                 String   @id @default(cuid())
  cuentaPorCobrarId  String
  cuentaBancariaId   String?
  monto              Float
  fechaPago          DateTime
  medioPago          String   @default("transferencia") // transferencia, cheque, efectivo, detraccion
  numeroOperacion    String?
  observaciones      String?
  esDetraccion          Boolean   @default(false)
  detraccionPorcentaje  Float?
  detraccionCodigo      String?
  detraccionMonto       Float?
  detraccionFechaPago   DateTime?
  numeroConstanciaBN    String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime

  cuentaPorCobrar CuentaPorCobrar @relation(fields: [cuentaPorCobrarId], references: [id], onDelete: Cascade)
  cuentaBancaria  CuentaBancaria? @relation(fields: [cuentaBancariaId], references: [id])

  @@index([cuentaPorCobrarId])
  @@index([fechaPago])
  @@map("pago_cobro")
}

model CuentaPorPagar {
  id                String             @id @default(cuid())
  proveedorId       String
  proyectoId        String?
  ordenCompraId     String?
  pedidoEquipoId    String?
  pedidoEquipoItemId String?
  tipoOrigen        String?            // "oc" | "atencion_directa" | "importacion_gerencia"
  numeroFactura     String?            // número de factura del proveedor
  descripcion       String?
  monto             Float
  moneda            String             @default("PEN")
  tipoCambio        Float?
  montoPagado       Float              @default(0) // calculado: SUM(pagosPagar.monto)
  saldoPendiente    Float              @default(0) // calculado: monto - montoPagado
  fechaRecepcion    DateTime
  fechaVencimiento  DateTime
  condicionPago     String             @default("contado") // contado, credito
  diasCredito       Int?
  estado            EstadoCuentaPagar  @default(pendiente)
  observaciones     String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime

  proveedor        Proveedor         @relation(fields: [proveedorId], references: [id])
  proyecto         Proyecto?         @relation(fields: [proyectoId], references: [id])
  ordenCompra      OrdenCompra?      @relation(fields: [ordenCompraId], references: [id])
  pedidoEquipo     PedidoEquipo?     @relation(fields: [pedidoEquipoId], references: [id])
  pedidoEquipoItem PedidoEquipoItem? @relation(fields: [pedidoEquipoItemId], references: [id])
  pagos            PagoPagar[]
  adjuntos         CxPAdjunto[]

  @@index([proveedorId, estado])
  @@index([proyectoId, estado])
  @@index([estado, fechaVencimiento])
  @@index([pedidoEquipoItemId])
  @@map("cuenta_por_pagar")
}

model PagoPagar {
  id                String   @id @default(cuid())
  cuentaPorPagarId  String
  cuentaBancariaId  String?
  monto             Float
  fechaPago         DateTime
  medioPago         String   @default("transferencia") // transferencia, cheque, efectivo
  numeroOperacion   String?
  observaciones     String?
  esDetraccion          Boolean   @default(false)
  detraccionPorcentaje  Float?
  detraccionCodigo      String?
  detraccionMonto       Float?
  detraccionFechaPago   DateTime?
  numeroConstanciaBN    String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime

  cuentaPorPagar CuentaPorPagar  @relation(fields: [cuentaPorPagarId], references: [id], onDelete: Cascade)
  cuentaBancaria CuentaBancaria? @relation(fields: [cuentaBancariaId], references: [id])

  @@index([cuentaPorPagarId])
  @@index([fechaPago])
  @@map("pago_pagar")
}

model CxPAdjunto {
  id               String         @id @default(cuid())
  cuentaPorPagarId String
  nombreArchivo    String
  urlArchivo       String
  driveFileId      String?
  tipoArchivo      String?        // "factura" | "transferencia" | "dua" | "otro"
  tamano           Int?
  subidoPorId      String
  createdAt        DateTime       @default(now())

  cuentaPorPagar CuentaPorPagar @relation(fields: [cuentaPorPagarId], references: [id], onDelete: Cascade)
  subidoPor      User           @relation("CxPAdjuntoSubidoPor", fields: [subidoPorId], references: [id])

  @@index([cuentaPorPagarId])
  @@map("cxp_adjunto")
}

model CxCAdjunto {
  id                String         @id @default(cuid())
  cuentaPorCobrarId String
  nombreArchivo     String
  urlArchivo        String
  driveFileId       String?
  tipoArchivo       String?        // "factura" | "voucher" | "valorizacion" | "otro"
  tamano            Int?
  subidoPorId       String
  createdAt         DateTime       @default(now())

  cuentaPorCobrar CuentaPorCobrar @relation(fields: [cuentaPorCobrarId], references: [id], onDelete: Cascade)
  subidoPor       User            @relation("CxCAdjuntoSubidoPor", fields: [subidoPorId], references: [id])

  @@index([cuentaPorCobrarId])
  @@map("cxc_adjunto")
}

// ======================
// ⏱️ Timesheet Aprobación
// ======================

enum EstadoTimesheet {
  borrador
  enviado
  aprobado
  rechazado
}

model TimesheetAprobacion {
  id              String          @id @default(cuid())
  usuarioId       String
  semana          String          // "2026-W07" ISO week
  estado          EstadoTimesheet @default(borrador)
  totalHoras      Float           @default(0)
  aprobadoPorId   String?
  motivoRechazo   String?
  fechaEnvio      DateTime?
  fechaResolucion DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime

  usuario     User  @relation("TimesheetUsuario", fields: [usuarioId], references: [id])
  aprobadoPor User? @relation("TimesheetAprobador", fields: [aprobadoPorId], references: [id])

  @@unique([usuarioId, semana])
  @@index([estado])
  @@map("timesheet_aprobacion")
}

// =============================================
// 🤖 Agente IA - Conversaciones
// =============================================
model AgenteConversacion {
  id             String                      @id @default(cuid())
  userId         String
  titulo         String?
  archivada      Boolean                     @default(false)
  cotizacionId   String?
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt

  user         User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  cotizacion   Cotizacion?                 @relation(fields: [cotizacionId], references: [id])
  mensajes     AgenteConversacionMensaje[]

  @@index([userId, archivada])
  @@index([userId, cotizacionId])
  @@index([updatedAt])
  @@map("agente_conversacion")
}

model AgenteConversacionMensaje {
  id             String   @id @default(cuid())
  conversacionId String
  userId         String?
  role           String   // 'user' | 'assistant'
  content        String   @db.Text
  attachments    Json?    // [{name, type, mimeType}] - sin base64
  toolCalls      Json?    // ToolCallInfo[]
  createdAt      DateTime @default(now())

  conversacion AgenteConversacion @relation(fields: [conversacionId], references: [id], onDelete: Cascade)
  user         User?              @relation(fields: [userId], references: [id])

  @@index([conversacionId, createdAt])
  @@index([userId])
  @@map("agente_conversacion_mensaje")
}

model AgenteUsage {
  id             String   @id @default(cuid())
  userId         String
  conversacionId String?
  tipo           String   // 'chat', 'chat-simple', 'pdf-preprocessing', 'excel-extraction', 'pdf-extraction', 'ocr'
  modelo         String   // model ID used
  tokensInput    Int
  tokensOutput   Int
  costoEstimado  Float    // USD
  duracionMs     Int?
  metadata       Json?
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([tipo])
  @@map("agente_usage")
}
